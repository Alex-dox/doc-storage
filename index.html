<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>DocStorage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: #181A1B;
      color: #F3F6F8;
      margin: 0;
      display: flex;
      height: 100vh;
    }
    aside {
      width: 260px;
      background: #202225;
      display: flex;
      flex-direction: column;
      padding: 24px 16px;
      border-right: 1px solid #2a2d2f;
      overflow-y: auto;
    }
    .menu-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }
    .menu-logo {
      font-weight: 600;
      font-size: 20px;
      color: #72E4A0;
    }
    .add-icon-btn {
      width: 32px;
      height: 32px;
      background: #72E4A0;
      color: #181A1B;
      border: none;
      border-radius: 6px;
      font-size: 20px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      line-height: 1;
    }
    .add-icon-btn:hover {
      background: #4BC483;
      transform: scale(1.05);
    }
    .search-box {
      margin-bottom: 20px;
    }
    .search-input {
      width: 100%;
      background: #2a2d2f;
      border: 1px solid #3a3d3f;
      border-radius: 8px;
      padding: 10px 12px;
      color: #F3F6F8;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
    }
    .search-input:focus {
      outline: none;
      border-color: #72E4A0;
    }
    .menu-section {
      margin-bottom: 24px;
    }
    .menu-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .menu-title {
      font-size: 12px;
      text-transform: uppercase;
      color: #74cba4;
      font-weight: 600;
    }
    .show-all-btn {
      font-size: 11px;
      color: #72E4A0;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      text-decoration: underline;
    }
    .show-all-btn:hover {
      color: #4BC483;
    }
    .menu-item {
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 14px;
      color: #B6BABF;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .menu-item:hover {
      background: #2a2d2f;
      color: #F3F6F8;
    }
    .menu-item.active {
      background: rgba(114, 228, 160, 0.15);
      color: #72E4A0;
    }
    .item-count {
      font-size: 12px;
      color: #6a6d6f;
      background: #2a2d2f;
      padding: 2px 6px;
      border-radius: 4px;
    }
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 32px 40px;
      overflow-y: auto;
    }
    .main-header {
      margin-bottom: 24px;
    }
    .main-title {
      font-size: 28px;
      font-weight: 600;
      margin: 0 0 8px 0;
    }
    .main-subtitle {
      font-size: 15px;
      color: #B6BABF;
    }
    .preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
    }
    .preview-card {
      background: #212324;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    .preview-card:hover {
      border-color: #72E4A0;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(114, 228, 160, 0.15);
    }
    .preview-header {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    .preview-icon {
      width: 48px;
      height: 48px;
      background: #2a2d2f;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
    }
    .preview-info {
      flex: 1;
      min-width: 0;
    }
    .preview-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #F3F6F8;
      line-height: 1.3;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .preview-category {
      font-size: 12px;
      color: #74cba4;
      font-weight: 500;
    }
    .preview-desc {
      font-size: 13px;
      color: #B6BABF;
      line-height: 1.5;
      margin-bottom: 12px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .preview-tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .preview-tag {
      background: rgba(114, 228, 160, 0.15);
      color: #72E4A0;
      font-size: 11px;
      border-radius: 6px;
      padding: 3px 8px;
    }
    .upload-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(24, 26, 27, 0.85);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 40px;
      overflow-y: auto;
    }
    .upload-modal.active {
      display: flex;
    }
    .upload-form {
      background: #212324;
      border-radius: 16px;
      max-width: 600px;
      width: 100%;
      padding: 32px 28px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .upload-form h2 {
      margin: 0 0 24px 0;
      font-size: 22px;
      color: #F3F6F8;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #74cba4;
      font-size: 14px;
      font-weight: 500;
    }
    .form-group input[type="text"],
    .form-group textarea,
    .form-group select {
      width: 100%;
      background: #2a2d2f;
      border: 1px solid #3a3d3f;
      border-radius: 8px;
      padding: 10px 12px;
      color: #F3F6F8;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    .file-input-wrapper {
      position: relative;
      background: #2a2d2f;
      border: 2px dashed #72E4A0;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .file-input-wrapper:hover {
      background: #323537;
      border-color: #4BC483;
    }
    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      cursor: pointer;
    }
    .file-input-label {
      color: #B6BABF;
      font-size: 14px;
    }
    .selected-file {
      margin-top: 12px;
      color: #72E4A0;
      font-size: 13px;
    }
    .tag-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px;
      background: #2a2d2f;
      border: 1px solid #3a3d3f;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
    }
    .tag-option {
      background: rgba(114, 228, 160, 0.1);
      color: #72E4A0;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }
    .tag-option:hover {
      background: rgba(114, 228, 160, 0.2);
    }
    .tag-option.selected {
      background: rgba(114, 228, 160, 0.25);
      border-color: #72E4A0;
    }
    .help-text {
      font-size: 12px;
      color: #6a6d6f;
      margin-top: 4px;
    }
    .form-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    .btn {
      flex: 1;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
    }
    .btn-primary {
      background: #72E4A0;
      color: #181A1B;
    }
    .btn-primary:hover {
      background: #4BC483;
    }
    .btn-primary:disabled {
      background: #3a3d3f;
      color: #6a6d6f;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: transparent;
      color: #B6BABF;
      border: 1px solid #3a3d3f;
    }
    .btn-secondary:hover {
      background: #2a2d2f;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(24, 26, 27, 0.85);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 40px;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal-card {
      background: #212324;
      border-radius: 16px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      padding: 32px 28px 28px 28px;
      animation: modalSlideIn 0.3s ease;
    }
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 32px;
      height: 32px;
      border: none;
      background: #2a2d2f;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      color: #B6BABF;
      font-size: 20px;
      z-index: 10;
    }
    .close-btn:hover {
      background: #72E4A0;
      color: #181A1B;
    }
    .doc-title {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #F3F6F8;
    }
    .doc-desc {
      font-size: 15px;
      color: #B6BABF;
      line-height: 1.6;
      margin-bottom: 24px;
    }
    .doc-fields-row {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      align-items: flex-start;
    }
    .doc-field-title {
      min-width: 110px;
      color: #74cba4;
      font-size: 14px;
      font-weight: 500;
    }
    .doc-tags {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      flex: 1;
    }
    .doc-tag {
      background: rgba(114, 228, 160, 0.15);
      color: #72E4A0;
      font-size: 13px;
      border-radius: 8px;
      padding: 4px 12px;
    }
    .doc-actions {
      margin: 0;
      padding: 0 0 0 18px;
      font-size: 14px;
      color: #DEE6EA;
      line-height: 1.6;
      flex: 1;
    }
    .doc-actions li {
      margin-bottom: 4px;
    }
    .doc-content {
      font-size: 14px;
      color: #DEE6EA;
      background: #2a2d2f;
      padding: 12px 14px;
      border-radius: 8px;
      line-height: 1.6;
      flex: 1;
    }
    .doc-actions-buttons {
      margin-top: 24px;
      display: flex;
      gap: 12px;
    }
    .download-btn, .delete-btn {
      background: #72E4A0;
      color: #181A1B;
      border: 0;
      border-radius: 8px;
      font-size: 14px;
      padding: 10px 20px;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
    }
    .delete-btn {
      background: transparent;
      color: #ff6b6b;
      border: 1.5px solid #ff6b6b;
    }
    .download-btn:hover {
      background: #4BC483;
    }
    .delete-btn:hover {
      background: rgba(255, 107, 107, 0.1);
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #B6BABF;
    }
  </style>
</head>
<body>
  <aside>
    <div class="menu-header">
      <div class="menu-logo">DocStorage</div>
      <button class="add-icon-btn" onclick="openUploadModal()">+</button>
    </div>
    
    <div class="search-box">
      <input type="text" class="search-input" id="searchInput" placeholder="–ü–æ–∏—Å–∫...">
    </div>

    <div class="menu-section">
      <div class="menu-section-header">
        <div class="menu-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
      </div>
      <div id="categoriesList"></div>
    </div>

    <div class="menu-section">
      <div class="menu-section-header">
        <div class="menu-title">–¢–µ–≥–∏</div>
        <button class="show-all-btn" id="showAllTagsBtn" onclick="toggleAllTags()">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
      </div>
      <div id="tagsList"></div>
    </div>
  </aside>

  <main>
    <div class="main-header">
      <h1 class="main-title" id="mainTitle">–í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</h1>
      <p class="main-subtitle">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π</p>
    </div>
    <div class="preview-grid" id="previewGrid">
      <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤...</div>
    </div>
  </main>

  <div class="upload-modal" id="uploadModal">
    <div class="upload-form">
      <h2>–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</h2>
      <form id="uploadForm">
        <div class="form-group">
          <label>–§–∞–π–ª *</label>
          <div class="file-input-wrapper">
            <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png" required>
            <div class="file-input-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª (PDF, JPEG, PNG)</div>
            <div class="selected-file" id="selectedFile"></div>
          </div>
        </div>
        
        <div class="form-group">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
          <input type="text" id="titleInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞" required>
        </div>
        
        <div class="form-group">
          <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="descInput" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞"></textarea>
        </div>

        <div class="form-group">
          <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
          <select id="categorySelect" required>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
          </select>
        </div>

        <div class="form-group">
          <label>–¢–µ–≥–∏</label>
          <div class="tag-selector" id="tagSelector"></div>
          <div class="help-text">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ç–µ–≥–∏</div>
        </div>

        <div class="form-group">
          <label>–î–µ–π—Å—Ç–≤–∏—è (—á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å)</label>
          <textarea id="actionsInput" placeholder="–ö–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏"></textarea>
        </div>

        <div class="form-group">
          <label>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</label>
          <textarea id="contentInput" placeholder="–û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞" style="min-height: 120px;"></textarea>
        </div>

        <div class="form-buttons">
          <button type="button" class="btn btn-secondary" onclick="closeUploadModal()">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn btn-primary" id="uploadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal-overlay" id="modalOverlay" onclick="closeModalOnOverlay(event)">
    <div class="modal-card" onclick="event.stopPropagation()">
      <button class="close-btn" onclick="closeModal()">√ó</button>
      <div id="modalContent"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    var SUPABASE_URL = 'https://zudvtnxzwnyxxtgmlenf.supabase.co';
    var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp1ZHZ0bnh6d255eHh0Z21sZW5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5MTIzNTAsImV4cCI6MjA3NjQ4ODM1MH0.ZJGsAv6H-rm6NzUrT_jWITvwZbrRDsxLcDSNOIfQzgk';
    var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    var PREDEFINED_CATEGORIES = ['–ñ–∏–ª—å–µ', '–§–∏–Ω–∞–Ω—Å—ã', '–†–∞–±–æ—Ç–∞', '–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è', '–ú–µ–¥–∏—Ü–∏–Ω–∞'];
    var PREDEFINED_TAGS = ['CAF', 'CADA', 'OFPRA', 'ANEF', 'France Travail', 'Credit Mutuel'];
    
    var allDocuments = [];
    var currentDocument = null;
    var selectedTags = [];
    var showAllTags = false;
    var currentFilter = { type: 'all', value: null };

    function initializeApp() {
      populateCategorySelect();
      populateTagSelector();
      loadDocuments();
      
      document.getElementById('searchInput').addEventListener('input', function(e) {
        searchDocuments(e.target.value);
      });
    }

    function populateCategorySelect() {
      var select = document.getElementById('categorySelect');
      for (var i = 0; i < PREDEFINED_CATEGORIES.length; i++) {
        var option = document.createElement('option');
        option.value = PREDEFINED_CATEGORIES[i];
        option.textContent = PREDEFINED_CATEGORIES[i];
        select.appendChild(option);
      }
    }

    function populateTagSelector() {
      var selector = document.getElementById('tagSelector');
      selector.innerHTML = '';
      for (var i = 0; i < PREDEFINED_TAGS.length; i++) {
        var tag = document.createElement('div');
        tag.className = 'tag-option';
        tag.textContent = PREDEFINED_TAGS[i];
        tag.onclick = (function(tagName) {
          return function() {
            toggleTag(tagName);
          };
        })(PREDEFINED_TAGS[i]);
        selector.appendChild(tag);
      }
    }

    function toggleTag(tagName) {
      var index = selectedTags.indexOf(tagName);
      if (index > -1) {
        selectedTags.splice(index, 1);
      } else {
        selectedTags.push(tagName);
      }
      updateTagSelector();
    }

    function updateTagSelector() {
      var options = document.querySelectorAll('.tag-option');
      for (var i = 0; i < options.length; i++) {
        var tagName = options[i].textContent;
        if (selectedTags.indexOf(tagName) > -1) {
          options[i].classList.add('selected');
        } else {
          options[i].classList.remove('selected');
        }
      }
    }

    function loadDocuments() {
      supabase.from('documents').select('*').order('created_at', { ascending: false })
        .then(function(response) {
          if (response.error) throw response.error;
          allDocuments = response.data || [];
          renderDocuments(allDocuments);
          updateFilters();
        })
        .catch(function(error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
          document.getElementById('previewGrid').innerHTML = '<div class="loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
        });
    }

    function renderDocuments(documents) {
      var grid = document.getElementById('previewGrid');
      if (documents.length === 0) {
        grid.innerHTML = '<div class="loading">–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤. –ù–∞–∂–º–∏—Ç–µ + –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è.</div>';
        return;
      }
      var html = '';
      for (var i = 0; i < documents.length; i++) {
        var doc = documents[i];
        var tagsHtml = '';
        if (doc.tags) {
          for (var j = 0; j < Math.min(doc.tags.length, 3); j++) {
            tagsHtml += '<span class="preview-tag">' + doc.tags[j] + '</span>';
          }
          if (doc.tags.length > 3) {
            tagsHtml += '<span class="preview-tag">+' + (doc.tags.length - 3) + '</span>';
          }
        }
        var category = (doc.categories && doc.categories.length > 0) ? doc.categories[0] : '';
        html += '<div class="preview-card" onclick="openDocumentModal(\'' + doc.id + '\')">' +
          '<div class="preview-header">' +
          '<div class="preview-icon">üìÑ</div>' +
          '<div class="preview-info">' +
          '<div class="preview-title">' + (doc.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è') + '</div>' +
          '<div class="preview-category">' + category + '</div>' +
          '</div></div>' +
          '<div class="preview-desc">' + (doc.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è') + '</div>' +
          '<div class="preview-tags">' + tagsHtml + '</div></div>';
      }
      grid.innerHTML = html;
    }

    function updateFilters() {
      var catCounts = {};
      var tagCounts = {};
      
      for (var i = 0; i < allDocuments.length; i++) {
        var doc = allDocuments[i];
        if (doc.categories) {
          for (var j = 0; j < doc.categories.length; j++) {
            var cat = doc.categories[j];
            catCounts[cat] = (catCounts[cat] || 0) + 1;
          }
        }
        if (doc.tags) {
          for (var j = 0; j < doc.tags.length; j++) {
            var tag = doc.tags[j];
            tagCounts[tag] = (tagCounts[tag] || 0) + 1;
          }
        }
      }

      var catList = document.getElementById('categoriesList');
      var catHtml = '<div class="menu-item' + (currentFilter.type === 'all' ? ' active' : '') + '" onclick="filterByAll()">–í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã<span class="item-count">' + allDocuments.length + '</span></div>';
      for (var i = 0; i < PREDEFINED_CATEGORIES.length; i++) {
        var cat = PREDEFINED_CATEGORIES[i];
        var count = catCounts[cat] || 0;
        var isActive = currentFilter.type === 'category' && currentFilter.value === cat;
        catHtml += '<div class="menu-item' + (isActive ? ' active' : '') + '" onclick="filterByCategory(\'' + cat + '\')">' + cat + '<span class="item-count">' + count + '</span></div>';
      }
      catList.innerHTML = catHtml;

      var tagsList = document.getElementById('tagsList');
      var tagsHtml = '';
      var tagsToShow = showAllTags ? Object.keys(tagCounts) : PREDEFINED_TAGS;
      for (var i = 0; i < tagsToShow.length; i++) {
        var tag = tagsToShow[i];
        var count = tagCounts[tag] || 0;
        if (count > 0) {
          var isActive = currentFilter.type === 'tag' && currentFilter.value === tag;
          tagsHtml += '<div class="menu-item' + (isActive ? ' active' : '') + '" onclick="filterByTag(\'' + tag + '\')">' + tag + '<span class="item-count">' + count + '</span></div>';
        }
      }
      tagsList.innerHTML = tagsHtml;
    }

    function toggleAllTags() {
      showAllTags = !showAllTags;
      var btn = document.getElementById('showAllTagsBtn');
      btn.textContent = showAllTags ? '–°–∫—Ä—ã—Ç—å' : '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ';
      updateFilters();
    }

    function filterByAll() {
      currentFilter = { type: 'all', value: null };
      document.getElementById('mainTitle').textContent = '–í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã';
      renderDocuments(allDocuments);
      updateFilters();
    }

    function filterByCategory(category) {
      currentFilter = { type: 'category', value: category };
      document.getElementById('mainTitle').textContent = category;
      var filtered = allDocuments.filter(function(doc) {
        return doc.categories && doc.categories.indexOf(category) > -1;
      });
      renderDocuments(filtered);
      updateFilters();
    }

    function filterByTag(tag) {
      currentFilter = { type: 'tag', value: tag };
      document.getElementById('mainTitle').textContent = '–¢–µ–≥: ' + tag;
      var filtered = allDocuments.filter(function(doc) {
        return doc.tags && doc.tags.indexOf(tag) > -1;
      });
      renderDocuments(filtered);
      updateFilters();
    }

    function searchDocuments(query) {
      if (!query) {
        renderDocuments(allDocuments);
        return;
      }
      query = query.toLowerCase();
      var filtered = allDocuments.filter(function(doc) {
        var titleMatch = doc.title && doc.title.toLowerCase().indexOf(query) > -1;
        var descMatch = doc.description && doc.description.toLowerCase().indexOf(query) > -1;
        var tagMatch = doc.tags && doc.tags.some(function(tag) {
          return tag.toLowerCase().indexOf(query) > -1;
        });
        var catMatch = doc.categories && doc.categories.some(function(cat) {
          return cat.toLowerCase().indexOf(query) > -1;
        });
        return titleMatch || descMatch || tagMatch || catMatch;
      });
      renderDocuments(filtered);
    }

    function openUploadModal() {
      selectedTags = [];
      document.getElementById('uploadModal').classList.add('active');
      updateTagSelector();
    }

    function closeUploadModal() {
      document.getElementById('uploadModal').classList.remove('active');
      document.getElementById('uploadForm').reset();
      document.getElementById('selectedFile').textContent = '';
      selectedTags = [];
      updateTagSelector();
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
      var file = e.target.files[0];
      if (file) {
        document.getElementById('selectedFile').textContent = '–í—ã–±—Ä–∞–Ω: ' + file.name;
        document.getElementById('titleInput').value = file.name.replace(/\.[^/.]+$/, "");
      }
    });

    document.getElementById('uploadForm').addEventListener('submit', function(e) {
      e.preventDefault();
      var fileInput = document.getElementById('fileInput');
      var file = fileInput.files[0];
      var title = document.getElementById('titleInput').value;
      var description = document.getElementById('descInput').value;
      var category = document.getElementById('categorySelect').value;
      var actionsText = document.getElementById('actionsInput').value;
      var content = document.getElementById('contentInput').value;
      
      var actions = [];
      if (actionsText) {
        var lines = actionsText.split('\n');
        for (var i = 0; i < lines.length; i++) {
          var line = lines[i].trim();
          if (line) actions.push(line);
        }
      }
      
      if (!file || !category) return;

      var uploadBtn = document.getElementById('uploadBtn');
      uploadBtn.disabled = true;
      uploadBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';

      var fileName = Date.now() + '_' + file.name;
      supabase.storage.from('documents').upload(fileName, file)
        .then(function(uploadResponse) {
          if (uploadResponse.error) throw uploadResponse.error;
          var urlData = supabase.storage.from('documents').getPublicUrl(fileName);
          return supabase.from('documents').insert([{
            filename: file.name,
            file_url: urlData.data.publicUrl,
            title: title,
            description: description,
            categories: [category],
            tags: selectedTags,
            actions: actions,
            content: content,
            lang: 'ru',
            ai_filled: false
          }]).select();
        })
        .then(function(docResponse) {
          if (docResponse.error) throw docResponse.error;
          alert('–î–æ–∫—É–º–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω!');
          closeUploadModal();
          loadDocuments();
        })
        .catch(function(error) {
          console.error('–û—à–∏–±–∫–∞:', error);
          alert('–û—à–∏–±–∫–∞: ' + error.message);
        })
        .finally(function() {
          uploadBtn.disabled = false;
          uploadBtn.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å';
        });
    });

    function openDocumentModal(docId) {
      var doc = null;
      for (var i = 0; i < allDocuments.length; i++) {
        if (allDocuments[i].id === docId) {
          doc = allDocuments[i];
          break;
        }
      }
      if (!doc) return;
      currentDocument = doc;

      var content = '<div class="doc-title">' + (doc.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è') + '</div>' +
        '<div class="doc-desc">' + (doc.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è') + '</div>';

      if (doc.categories && doc.categories.length > 0) {
        var catsHtml = '';
        for (var i = 0; i < doc.categories.length; i++) {
          catsHtml += '<span class="doc-tag">' + doc.categories[i] + '</span>';
        }
        content += '<div class="doc-fields-row"><div class="doc-field-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:</div><div class="doc-tags">' + catsHtml + '</div></div>';
      }

      if (doc.tags && doc.tags.length > 0) {
        var tagsHtml = '';
        for (var i = 0; i < doc.tags.length; i++) {
          tagsHtml += '<span class="doc-tag">' + doc.tags[i] + '</span>';
        }
        content += '<div class="doc-fields-row"><div class="doc-field-title">–¢–µ–≥–∏:</div><div class="doc-tags">' + tagsHtml + '</div></div>';
      }

      if (doc.actions && doc.actions.length > 0) {
        var actionsHtml = '<ul class="doc-actions">';
        for (var i = 0; i < doc.actions.length; i++) {
          actionsHtml += '<li>' + doc.actions[i] + '</li>';
        }
        actionsHtml += '</ul>';
        content += '<div class="doc-fields-row"><div class="doc-field-title">–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:</div>' + actionsHtml + '</div>';
      }

      if (doc.content) {
        content += '<div class="doc-fields-row"><div class="doc-field-title">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:</div><div class="doc-content">' + doc.content + '</div></div>';
      }

      content += '<div class="doc-actions-buttons">' +
        '<a class="download-btn" href="' + doc.file_url + '" download="' + doc.filename + '" target="_blank">–°–∫–∞—á–∞—Ç—å</a>' +
        '<button class="delete-btn" onclick="deleteDocument(\'' + doc.id + '\')">–£–¥–∞–ª–∏—Ç—å</button>' +
        '</div>';

      document.getElementById('modalContent').innerHTML = content;
      document.getElementById('modalOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function deleteDocument(docId) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç?')) return;
      var doc = null;
      for (var i = 0; i < allDocuments.length; i++) {
        if (allDocuments[i].id === docId) {
          doc = allDocuments[i];
          break;
        }
      }
      if (!doc) return;

      var fileName = doc.file_url.split('/').pop();
      supabase.storage.from('documents').remove([fileName])
        .then(function() {
          return supabase.from('documents').delete().eq('id', docId);
        })
        .then(function(response) {
          if (response.error) throw response.error;
          alert('–î–æ–∫—É–º–µ–Ω—Ç —É–¥–∞–ª–µ–Ω');
          closeModal();
          loadDocuments();
        })
        .catch(function(error) {
          console.error('–û—à–∏–±–∫–∞:', error);
          alert('–û—à–∏–±–∫–∞: ' + error.message);
        });
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('active');
      document.body.style.overflow = 'auto';
      currentDocument = null;
    }

    function closeModalOnOverlay(event) {
      if (event.target.id === 'modalOverlay') {
        closeModal();
      }
    }

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeModal();
        closeUploadModal();
      }
    });

    initializeApp();
  </script>
</body>
</html>
