<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>DocStorage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: #181A1B; color: #F3F6F8; margin: 0; display: flex; height: 100vh; }
    aside { width: 260px; background: #202225; display: flex; flex-direction: column; padding: 24px 16px; border-right: 1px solid #2a2d2f; overflow-y: auto; }
    .menu-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
    .menu-logo { font-weight: 600; font-size: 20px; color: #72E4A0; }
    .add-icon-btn { width: 32px; height: 32px; background: #72E4A0; color: #181A1B; border: none; border-radius: 6px; font-size: 20px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; line-height: 1; }
    .add-icon-btn:hover { background: #4BC483; transform: scale(1.05); }
    .search-section { margin-bottom: 20px; }
    .search-label { font-size: 11px; color: #74cba4; font-weight: 600; text-transform: uppercase; margin-bottom: 6px; }
    .search-input { width: 100%; background: #2a2d2f; border: 1px solid #3a3d3f; border-radius: 8px; padding: 10px 12px; color: #F3F6F8; }

    .gear-btn { background: transparent; border: none; color: #72E4A0; font-size: 16px; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s; opacity: 0.7; display: flex; align-items: center; justify-content: center; }
    .gear-btn:hover { opacity: 1; background: rgba(114, 228, 160, 0.1); transform: rotate(90deg); }
  </style>
</head>
<body>
  <aside>
    <div class="menu-header">
      <div class="menu-logo">DocStorage</div>
      <button class="add-icon-btn" id="addBtn">+</button>
    </div>

    <div class="search-section">
      <div class="search-label">Поиск</div>
      <input class="search-input" id="textSearch" placeholder="Введите запрос" oninput="applyFilters()" />
    </div>

    <div class="search-section">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
        <div class="search-label">Теги</div>
        <button class="gear-btn" onclick="openTagsManager()" title="Управление тегами">⚙️</button>
      </div>
      <div class="search-tags-container" id="selectedSearchTags"></div>
      <div class="tag-suggestions" id="tagSuggestions"></div>
      <div style="margin-top: 10px; padding: 8px; background: rgba(42, 45, 47, 0.5); border-radius: 6px;">
        <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; color: #a8b5bc;">
          <input type="checkbox" id="tagsAndToggle" onchange="applyFilters()" style="margin-right: 8px; cursor: pointer; accent-color: #72E4A0; width: 14px; height: 14px;">
          <span style="user-select: none;">Только со всеми тегами (И)</span>
        </label>
      </div>
    </div>

    <div class="search-section">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
        <div class="search-label">Категория</div>
        <button class="gear-btn" onclick="openCategoriesManager()" title="Управление категориями">⚙️</button>
      </div>
      <select class="search-input" id="categoryFilter" onchange="applyFilters()">
        <option value="">Все категории</option>
      </select>
    </div>

    <div id="modalContent"></div>
  </aside>

  <main style="flex:1; overflow-y:auto;">
    <div id="documentsContainer"></div>
  </main>

  <div id="tagsManagerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 2000; justify-content: center; align-items: center;">
    <div style="background: #202225; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #2a2d2f;">
        <div style="font-size: 18px; font-weight: 600; color: #F3F6F8;">Управление тегами</div>
        <button onclick="closeTagsManager()" style="background: transparent; border: none; color: #a8b5bc; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">×</button>
      </div>
      <div style="margin-bottom: 20px; padding: 16px; background: rgba(42, 45, 47, 0.5); border-radius: 8px;">
        <input type="text" id="newTagInput" placeholder="Название нового тега" style="width: 100%; background: #2a2d2f; border: 1px solid #3a3d3f; border-radius: 6px; padding: 10px 12px; color: #F3F6F8; font-family: 'Inter', sans-serif; font-size: 14px; margin-bottom: 10px; box-sizing: border-box;">
        <button onclick="addNewTag()" style="width: 100%; background: #72E4A0; color: #181A1B; border: none; border-radius: 6px; padding: 10px; font-weight: 600; font-size: 14px; cursor: pointer;">+ Добавить тег</button>
      </div>
      <div id="tagsManagerList"></div>
    </div>
  </div>

  <div id="categoriesManagerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 2000; justify-content: center; align-items: center;">
    <div style="background: #202225; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #2a2d2f;">
        <div style="font-size: 18px; font-weight: 600; color: #F3F6F8;">Управление категориями</div>
        <button onclick="closeCategoriesManager()" style="background: transparent; border: none; color: #a8b5bc; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">×</button>
      </div>
      <div style="margin-bottom: 20px; padding: 16px; background: rgba(42, 45, 47, 0.5); border-radius: 8px;">
        <input type="text" id="newCategoryInput" placeholder="Название новой категории" style="width: 100%; background: #2a2d2f; border: 1px solid #3a3d3f; border-radius: 6px; padding: 10px 12px; color: #F3F6F8; font-family: 'Inter', sans-serif; font-size: 14px; margin-bottom: 10px; box-sizing: border-box;">
        <button onclick="addNewCategory()" style="width: 100%; background: #72E4A0; color: #181A1B; border: none; border-radius: 6px; padding: 10px; font-weight: 600; font-size: 14px; cursor: pointer;">+ Добавить категорию</button>
      </div>
      <div id="categoriesManagerList"></div>
    </div>
  </div>

  <div class="preview-modal" id="previewModal"></div>

  <script>
    var allDocuments = JSON.parse(localStorage.getItem('documents') || '[]');
    var availableTags = JSON.parse(localStorage.getItem('availableTags') || '[]');
    var availableCategories = JSON.parse(localStorage.getItem('availableCategories') || '[]');
    var selectedSearchTags = [];
    var currentDocument = null;

    function renderDocuments(list){
      var c = document.getElementById('documentsContainer');
      c.innerHTML = (list||[]).map(function(d){return '<div>'+ (d.title||'') +'</div>';}).join('');
    }

    function updateTagSuggestions(){}
    function populateTagSelector(){}
    function populateCategorySelect(){}
    function populateCategoryFilter(){}
    function renderSearchTags(){}

    function applyFilters() {
      var textQuery = (document.getElementById('textSearch')||{}).value ? document.getElementById('textSearch').value.toLowerCase() : '';
      var categoryFilter = (document.getElementById('categoryFilter')||{}).value || '';
      var useAndLogic = document.getElementById('tagsAndToggle') ? document.getElementById('tagsAndToggle').checked : false;
      var filtered = allDocuments.filter(function(doc) {
        var textMatch = !textQuery || 
          (doc.title && doc.title.toLowerCase().indexOf(textQuery) > -1) ||
          (doc.description && doc.description.toLowerCase().indexOf(textQuery) > -1);
        var categoryMatch = !categoryFilter || 
          (doc.categories && doc.categories.indexOf(categoryFilter) > -1);
        var tagsMatch = true;
        if (selectedSearchTags.length > 0) {
          if (useAndLogic) {
            tagsMatch = doc.tags && selectedSearchTags.every(function(tag) { return doc.tags.indexOf(tag) > -1; });
          } else {
            tagsMatch = doc.tags && selectedSearchTags.some(function(tag) { return doc.tags.indexOf(tag) > -1; });
          }
        }
        return textMatch && categoryMatch && tagsMatch;
      });
      renderDocuments(filtered);
    }

    // switchLanguage removed

    function openTagsManager() { renderTagsManager(); document.getElementById('tagsManagerModal').style.display = 'flex'; }
    function closeTagsManager() { document.getElementById('tagsManagerModal').style.display = 'none'; var el=document.getElementById('newTagInput'); if(el) el.value=''; }
    function renderTagsManager() {
      var list = document.getElementById('tagsManagerList');
      var html = '';
      if (availableTags.length === 0) { html = '<div style="color: #a8b5bc; text-align: center; padding: 20px;">Нет тегов</div>'; }
      else {
        for (var i = 0; i < availableTags.length; i++) {
          var tag = availableTags[i];
          var safeTag = tag.replace(/'/g, "\\'");
          html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #2a2d2f; border-radius: 6px; margin-bottom: 8px;">' +
                  '<div style="color: #F3F6F8; font-size: 14px;">' + tag + '</div>' +
                  '<button onclick="deleteTag(\'' + safeTag + '\')" style="background: transparent; border: 1px solid #e74c3c; color: #e74c3c; border-radius: 4px; padding: 6px 12px; font-size: 12px; cursor: pointer; font-weight: 500;">Удалить</button>' +
                  '</div>';
        }
      }
      list.innerHTML = html;
    }
    function addNewTag() {
      var input = document.getElementById('newTagInput');
      var tagName = input.value.trim();
      if (!tagName) { alert('Введите название тега'); return; }
      if (availableTags.indexOf(tagName) > -1) { alert('Такой тег уже существует'); return; }
      availableTags.push(tagName);
      localStorage.setItem('availableTags', JSON.stringify(availableTags));
      input.value = '';
      renderTagsManager();
      updateTagSuggestions();
      populateTagSelector();
    }
    function deleteTag(tagName) {
      if (!confirm('Удалить тег "' + tagName + '"?')) { return; }
      var index = availableTags.indexOf(tagName);
      if (index > -1) { availableTags.splice(index, 1); localStorage.setItem('availableTags', JSON.stringify(availableTags)); }
      var searchIndex = selectedSearchTags.indexOf(tagName);
      if (searchIndex > -1) { selectedSearchTags.splice(searchIndex, 1); renderSearchTags(); }
      for (var i = 0; i < allDocuments.length; i++) {
        if (allDocuments[i].tags) {
          var tagIndex = allDocuments[i].tags.indexOf(tagName);
          if (tagIndex > -1) { allDocuments[i].tags.splice(tagIndex, 1); }
        }
      }
      localStorage.setItem('documents', JSON.stringify(allDocuments));
      renderTagsManager();
      updateTagSuggestions();
      populateTagSelector();
      applyFilters();
    }

    function openCategoriesManager() { renderCategoriesManager(); document.getElementById('categoriesManagerModal').style.display = 'flex'; }
    function closeCategoriesManager() { document.getElementById('categoriesManagerModal').style.display = 'none'; var el=document.getElementById('newCategoryInput'); if(el) el.value=''; }
    function renderCategoriesManager() {
      var list = document.getElementById('categoriesManagerList');
      var html = '';
      if (availableCategories.length === 0) { html = '<div style="color: #a8b5bc; text-align: center; padding: 20px;">Нет категорий</div>'; }
      else {
        for (var i = 0; i < availableCategories.length; i++) {
          var category = availableCategories[i];
          var safeCategory = category.replace(/'/g, "\\'");
          html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #2a2d2f; border-radius: 6px; margin-bottom: 8px;">' +
                  '<div style="color:
