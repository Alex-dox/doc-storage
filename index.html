<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>DocStorage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: #181A1B;
      color: #F3F6F8;
      margin: 0;
      display: flex;
      height: 100vh;
    }
    aside {
      width: 260px;
      background: #202225;
      display: flex;
      flex-direction: column;
      padding: 24px 16px;
      border-right: 1px solid #2a2d2f;
      overflow-y: auto;
    }
    .menu-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }
    .menu-logo {
      font-weight: 600;
      font-size: 20px;
      color: #72E4A0;
    }
    .add-icon-btn {
      width: 32px;
      height: 32px;
      background: #72E4A0;
      color: #181A1B;
      border: none;
      border-radius: 6px;
      font-size: 20px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      line-height: 1;
    }
    .add-icon-btn:hover {
      background: #4BC483;
      transform: scale(1.05);
    }
    .search-section {
      margin-bottom: 20px;
    }
    .search-label {
      font-size: 11px;
      color: #74cba4;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 6px;
    }
    .search-input {
      width: 100%;
      background: #2a2d2f;
      border: 1px solid #3a3d3f;
      border-radius: 8px;
      padding: 10px 12px;
      color: #F3F6F8;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .search-input:focus {
      outline: none;
      border-color: #72E4A0;
    }
    .search-tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }
    .search-tag {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .search-tag-remove {
      font-weight: bold;
      opacity: 0.7;
    }
    .search-tag-remove:hover {
      opacity: 1;
    }
    .tag-suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }
    .tag-suggestion {
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .tag-suggestion:hover {
      opacity: 0.8;
    }
    .menu-section {
      margin-bottom: 24px;
    }
    .menu-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .menu-title {
      font-size: 12px;
      text-transform: uppercase;
      color: #74cba4;
      font-weight: 600;
    }
    .menu-item {
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 14px;
      color: #B6BABF;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .menu-item:hover {
      background: #2a2d2f;
      color: #F3F6F8;
    }
    .menu-item.active {
      background: rgba(114, 228, 160, 0.15);
      color: #72E4A0;
    }
    .item-count {
      font-size: 12px;
      color: #6a6d6f;
      background: #2a2d2f;
      padding: 2px 6px;
      border-radius: 4px;
    }
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 32px 40px;
      overflow-y: auto;
    }
    .main-header {
      margin-bottom: 24px;
    }
    .main-title {
      font-size: 28px;
      font-weight: 600;
      margin: 0 0 8px 0;
    }
    .main-subtitle {
      font-size: 15px;
      color: #B6BABF;
    }
    .preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
    }
    .preview-card {
      background: #212324;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    .preview-card:hover {
      border-color: #72E4A0;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(114, 228, 160, 0.15);
    }
    .preview-header {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    .preview-icon {
      width: 48px;
      height: 48px;
      background: #2a2d2f;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
    }
    .preview-info {
      flex: 1;
      min-width: 0;
    }
    .preview-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #F3F6F8;
      line-height: 1.3;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .preview-category {
      font-size: 12px;
      color: #74cba4;
      font-weight: 500;
    }
    .preview-desc {
      font-size: 13px;
      color: #B6BABF;
      line-height: 1.5;
      margin-bottom: 12px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .preview-tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .preview-tag {
      font-size: 11px;
      border-radius: 6px;
      padding: 3px 8px;
    }
    .upload-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(24, 26, 27, 0.85);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 40px;
      overflow-y: auto;
    }
    .upload-modal.active {
      display: flex;
    }
    .upload-form {
      background: #212324;
      border-radius: 16px;
      max-width: 600px;
      width: 100%;
      padding: 32px 28px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .upload-form h2 {
      margin: 0 0 24px 0;
      font-size: 22px;
      color: #F3F6F8;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #74cba4;
      font-size: 14px;
      font-weight: 500;
    }
    .form-group input[type="text"],
    .form-group textarea,
    .form-group select {
      width: 100%;
      background: #2a2d2f;
      border: 1px solid #3a3d3f;
      border-radius: 8px;
      padding: 10px 12px;
      color: #F3F6F8;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    .file-input-wrapper {
      position: relative;
      background: #2a2d2f;
      border: 2px dashed #72E4A0;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .file-input-wrapper:hover {
      background: #323537;
      border-color: #4BC483;
    }
    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      cursor: pointer;
    }
    .file-input-label {
      color: #B6BABF;
      font-size: 14px;
    }
    .selected-file {
      margin-top: 12px;
      color: #72E4A0;
      font-size: 13px;
    }
    .ai-status {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 13px;
      display: none;
    }
    .ai-status.analyzing {
      display: block;
      background: rgba(114, 228, 160, 0.1);
      color: #72E4A0;
      border: 1px solid rgba(114, 228, 160, 0.3);
    }
    .ai-status.error {
      display: block;
      background: rgba(255, 159, 64, 0.1);
      color: #ff9f40;
      border: 1px solid rgba(255, 159, 64, 0.3);
    }
    .tag-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px;
      background: #2a2d2f;
      border: 1px solid #3a3d3f;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
    }
    .tag-option {
      background: rgba(114, 228, 160, 0.1);
      color: #72E4A0;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }
    .tag-option:hover {
      background: rgba(114, 228, 160, 0.2);
    }
    .tag-option.selected {
      background: rgba(114, 228, 160, 0.25);
      border-color: #72E4A0;
    }
    .help-text {
      font-size: 12px;
      color: #6a6d6f;
      margin-top: 4px;
    }
    .form-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    .btn {
      flex: 1;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
    }
    .btn-primary {
      background: #72E4A0;
      color: #181A1B;
    }
    .btn-primary:hover {
      background: #4BC483;
    }
    .btn-primary:disabled {
      background: #3a3d3f;
      color: #6a6d6f;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: transparent;
      color: #B6BABF;
      border: 1px solid #3a3d3f;
    }
    .btn-secondary:hover {
      background: #2a2d2f;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(24, 26, 27, 0.85);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 40px;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal-card {
      background: #212324;
      border-radius: 16px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      padding: 32px 28px 28px 28px;
      animation: modalSlideIn 0.3s ease;
    }
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 32px;
      height: 32px;
      border: none;
      background: #2a2d2f;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      color: #B6BABF;
      font-size: 20px;
      z-index: 10;
    }
    .close-btn:hover {
      background: #72E4A0;
      color: #181A1B;
    }
    .lang-switcher {
      position: absolute;
      top: 20px;
      right: 64px;
      display: flex;
      gap: 4px;
      background: #2a2d2f;
      border-radius: 8px;
      padding: 4px;
      z-index: 10;
    }
    .lang-btn {
      background: transparent;
      border: none;
      color: #B6BABF;
      font-size: 13px;
      font-weight: 500;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
    }
    .lang-btn:hover {
      color: #F3F6F8;
    }
    .lang-btn.active {
      background: #72E4A0;
      color: #181A1B;
    }
    .editable-input {
      width: 100%;
      background: #2a2d2f;
      border: 1px solid #3a3d3f;
      border-radius: 8px;
      padding: 10px 12px;
      color: #F3F6F8;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
    }
    .editable-input:focus {
      outline: none;
      border-color: #72E4A0;
    }
    .doc-title {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #F3F6F8;
      padding-right: 140px;
    }
    .doc-title-edit {
      margin-top: 40px;
      margin-bottom: 8px;
    }
    .doc-desc {
      font-size: 15px;
      color: #B6BABF;
      line-height: 1.6;
      margin-bottom: 24px;
    }
    .doc-desc-edit {
      margin-bottom: 24px;
    }
    .doc-fields-row {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      align-items: flex-start;
    }
    .doc-field-title {
      min-width: 110px;
      color: #74cba4;
      font-size: 14px;
      font-weight: 500;
    }
    .doc-tags {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      flex: 1;
    }
    .doc-tag {
      font-size: 13px;
      border-radius: 8px;
      padding: 4px 12px;
    }
    .doc-actions-list {
      margin: 0;
      padding: 0 0 0 18px;
      font-size: 14px;
      color: #DEE6EA;
      line-height: 1.6;
      flex: 1;
    }
    .doc-actions-list li {
      margin-bottom: 4px;
    }
    .doc-actions-list.collapsed li:nth-child(n+6) {
      display: none;
    }
    .show-more-actions {
      background: none;
      border: none;
      color: #72E4A0;
      font-size: 13px;
      cursor: pointer;
      margin-top: 8px;
      padding: 0;
      text-decoration: underline;
    }
    .show-more-actions:hover {
      color: #4BC483;
    }
    .doc-content {
      font-size: 14px;
      color: #DEE6EA;
      background: #2a2d2f;
      padding: 12px 14px;
      border-radius: 8px;
      line-height: 1.6;
      flex: 1;
    }
    .doc-actions-buttons {
      margin-top: 24px;
      display: flex;
      gap: 12px;
    }
    .edit-buttons {
      margin-top: 24px;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    .edit-buttons .btn {
      flex: 0 0 auto;
      min-width: 120px;
    }
    .icon-btn {
      width: 40px;
      height: 40px;
      background: #2a2d2f;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      color: #B6BABF;
      font-size: 18px;
      text-decoration: none;
    }
    .icon-btn:hover {
      background: #3a3d3f;
      color: #F3F6F8;
    }
    .icon-btn.delete:hover {
      background: rgba(255, 107, 107, 0.15);
      color: #ff6b6b;
    }
    .preview-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(24, 26, 27, 0.95);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 40px;
    }
    .preview-modal.active {
      display: flex;
    }
    .preview-container {
      background: #212324;
      border-radius: 16px;
      max-width: 90vw;
      max-height: 90vh;
      width: 100%;
      height: 100%;
      position: relative;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .preview-header {
      padding: 20px 24px;
      border-bottom: 1px solid #2a2d2f;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .preview-title-text {
      font-size: 18px;
      font-weight: 600;
      color: #F3F6F8;
    }
    .preview-content {
      flex: 1;
      overflow: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .preview-content iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 8px;
    }
    .preview-content img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 8px;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #B6BABF;
    }
  </style>
</head>
<body>
  <aside>
    <div class="menu-header">
      <div class="menu-logo">DocStorage</div>
      <button class="add-icon-btn" onclick="openUploadModal()">+</button>
    </div>
    
    <div class="search-section">
      <div class="search-label">Поиск по тексту</div>
      <input type="text" class="search-input" id="textSearch" placeholder="Название, описание...">
    </div>

    <div class="search-section">
      <div class="search-label">Теги</div>
      <div class="search-tags-container" id="selectedSearchTags"></div>
      <div class="tag-suggestions" id="tagSuggestions"></div>
    </div>

    <div class="search-section">
      <div class="search-label">Категория</div>
      <select class="search-input" id="categoryFilter">
        <option value="">Все категории</option>
      </select>
    </div>

    <div class="menu-section">
      <div class="menu-section-header">
        <div class="menu-title">Категории</div>
      </div>
      <div id="categoriesList"></div>
    </div>
  </aside>

  <main>
    <div class="main-header">
      <h1 class="main-title" id="mainTitle">Все документы</h1>
      <p class="main-subtitle">Кликните на карточку для просмотра деталей</p>
    </div>
    <div class="preview-grid" id="previewGrid">
      <div class="loading">Загрузка документов...</div>
    </div>
  </main>

  <div class="upload-modal" id="uploadModal">
    <div class="upload-form">
      <h2>Загрузить документ</h2>
      <form id="uploadForm">
        <div class="form-group">
          <label>Файл *</label>
          <div class="file-input-wrapper">
            <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png" required>
            <div class="file-input-label">Выберите файл (PDF, JPEG, PNG)</div>
            <div class="selected-file" id="selectedFile"></div>
            <div class="ai-status" id="aiStatus"></div>
          </div>
        </div>
        
        <div class="form-group">
          <label>Название *</label>
          <input type="text" id="titleInput" placeholder="Название документа" required>
        </div>
        
        <div class="form-group">
          <label>Описание</label>
          <textarea id="descInput" placeholder="Краткое описание документа"></textarea>
        </div>

        <div class="form-group">
          <label>Категория *</label>
          <select id="categorySelect" required>
            <option value="">Выберите категорию</option>
          </select>
        </div>

        <div class="form-group">
          <label>Теги</label>
          <div class="tag-selector" id="tagSelector"></div>
          <div class="help-text">Выберите релевантные теги</div>
        </div>

        <div class="form-group">
          <label>Действия (важная информация, коды, даты, что нужно сделать)</label>
          <textarea id="actionsInput" placeholder="Каждое действие с новой строки, например:&#10;Код: 123456&#10;Срок: 1 ноября 2025&#10;Оплатить счет"></textarea>
        </div>

        <div class="form-group">
          <label>Содержание</label>
          <textarea id="contentInput" placeholder="Основное содержание документа" style="min-height: 120px;"></textarea>
        </div>

        <div class="form-buttons">
          <button type="button" class="btn btn-secondary" onclick="closeUploadModal()">Отмена</button>
          <button type="submit" class="btn btn-primary" id="uploadBtn">Загрузить</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal-overlay" id="modalOverlay" onclick="closeModalOnOverlay(event)">
    <div class="modal-card" onclick="event.stopPropagation()">
      <button class="close-btn" onclick="closeModal()">×</button>
      <div class="lang-switcher">
        <button class="lang-btn active" data-lang="ru" onclick="switchLanguage('ru')">RU</button>
        <button class="lang-btn" data-lang="fr" onclick="switchLanguage('fr')">FR</button>
      </div>
      <div id="modalContent"></div>
    </div>
  </div>

  <div class="preview-modal" id="previewModal" onclick="closePreview(event)">
    <div class="preview-container" onclick="event.stopPropagation()">
      <div class="preview-header">
        <div class="preview-title-text" id="previewTitle">Просмотр документа</div>
        <button class="close-btn" onclick="closePreview()">×</button>
      </div>
      <div class="preview-content" id="previewContent">
        <div class="loading">Загрузка...</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    var SUPABASE_URL = 'https://zudvtnxzwnyxxtgmlenf.supabase.co';
    var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp1ZHZ0bnh6d255eHh0Z21sZW5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5MTIzNTAsImV4cCI6MjA3NjQ4ODM1MH0.ZJGsAv6H-rm6NzUrT_jWITvwZbrRDsxLcDSNOIfQzgk';
    var GEMINI_API_KEY = 'AIzaSyCzXEv7Ut3U3Q7Q9wPQG4FmaG4C8RkFec0';
    var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    var PREDEFINED_CATEGORIES = ['Жилье', 'Финансы', 'Работа', 'Идентификация', 'Медицина'];
    var PREDEFINED_TAGS = ['CAF', 'CADA', 'OFPRA', 'ANEF', 'France Travail', 'Credit Mutuel'];
    var TAG_COLORS = {
      'CAF': 'background: rgba(255, 99, 132, 0.2); color: #ff6384;',
      'CADA': 'background: rgba(54, 162, 235, 0.2); color: #36a2eb;',
      'OFPRA': 'background: rgba(255, 206, 86, 0.2); color: #ffce56;',
      'ANEF': 'background: rgba(75, 192, 192, 0.2); color: #4bc0c0;',
      'France Travail': 'background: rgba(153, 102, 255, 0.2); color: #9966ff;',
      'Credit Mutuel': 'background: rgba(255, 159, 64, 0.2); color: #ff9f40;'
    };
    
    var allDocuments = [];
    var currentDocument = null;
    var selectedTags = [];
    var selectedEditTags = [];
    var selectedSearchTags = [];
    var isEditMode = false;

    function getTagStyle(tag) {
      return TAG_COLORS[tag] || 'background: rgba(114, 228, 160, 0.2); color: #72E4A0;';
    }

    function initializeApp() {
      populateCategorySelect();
      populateCategoryFilter();
      populateTagSelector();
      updateTagSuggestions();
      loadDocuments();
      
      document.getElementById('textSearch').addEventListener('input', applyFilters);
      document.getElementById('categoryFilter').addEventListener('change', applyFilters);
    }

    function populateCategorySelect() {
      var select = document.getElementById('categorySelect');
      for (var i = 0; i < PREDEFINED_CATEGORIES.length; i++) {
        var option = document.createElement('option');
        option.value = PREDEFINED_CATEGORIES[i];
        option.textContent = PREDEFINED_CATEGORIES[i];
        select.appendChild(option);
      }
    }

    function populateCategoryFilter() {
      var select = document.getElementById('categoryFilter');
      for (var i = 0; i < PREDEFINED_CATEGORIES.length; i++) {
        var option = document.createElement('option');
        option.value = PREDEFINED_CATEGORIES[i];
        option.textContent = PREDEFINED_CATEGORIES[i];
        select.appendChild(option);
      }
    }

    function populateTagSelector() {
      var selector = document.getElementById('tagSelector');
      selector.innerHTML = '';
      for (var i = 0; i < PREDEFINED_TAGS.length; i++) {
        var tag = document.createElement('div');
        tag.className = 'tag-option';
        tag.textContent = PREDEFINED_TAGS[i];
        tag.onclick = (function(tagName) {
          return function() {
            toggleTag(tagName);
          };
        })(PREDEFINED_TAGS[i]);
        selector.appendChild(tag);
      }
    }

    function populateEditTagSelector() {
      var selector = document.getElementById('editTagSelector');
      if (!selector) return;
      selector.innerHTML = '';
      for (var i = 0; i < PREDEFINED_TAGS.length; i++) {
        var tag = document.createElement('div');
        tag.className = 'tag-option';
        tag.textContent = PREDEFINED_TAGS[i];
        if (selectedEditTags.indexOf(PREDEFINED_TAGS[i]) > -1) {
          tag.classList.add('selected');
        }
        tag.onclick = (function(tagName) {
          return function() {
            toggleEditTag(tagName);
          };
        })(PREDEFINED_TAGS[i]);
        selector.appendChild(tag);
      }
    }

    function toggleEditTag(tagName) {
      var index = selectedEditTags.indexOf(tagName);
      if (index > -1) {
        selectedEditTags.splice(index, 1);
      } else {
        selectedEditTags.push(tagName);
      }
      populateEditTagSelector();
    }

    function updateTagSuggestions() {
      var allTags = [];
      for (var i = 0; i < allDocuments.length; i++) {
        if (allDocuments[i].tags) {
          for (var j = 0; j < allDocuments[i].tags.length; j++) {
            var tag = allDocuments[i].tags[j];
            if (allTags.indexOf(tag) === -1 && selectedSearchTags.indexOf(tag) === -1) {
              allTags.push(tag);
            }
          }
        }
      }
      
      var container = document.getElementById('tagSuggestions');
      container.innerHTML = '';
      for (var i = 0; i < Math.min(allTags.length, 6); i++) {
        var tag = allTags[i];
        var el = document.createElement('div');
        el.className = 'tag-suggestion';
        el.textContent = tag;
        el.style.cssText = getTagStyle(tag);
        el.onclick = (function(tagName) {
          return function() {
            addSearchTag(tagName);
          };
        })(tag);
        container.appendChild(el);
      }
    }

    function addSearchTag(tag) {
      if (selectedSearchTags.indexOf(tag) === -1) {
        selectedSearchTags.push(tag);
        renderSearchTags();
        updateTagSuggestions();
        applyFilters();
      }
    }

    function removeSearchTag(tag) {
      var index = selectedSearchTags.indexOf(tag);
      if (index > -1) {
        selectedSearchTags.splice(index, 1);
        renderSearchTags();
        updateTagSuggestions();
        applyFilters();
      }
    }

    function renderSearchTags() {
      var container = document.getElementById('selectedSearchTags');
      container.innerHTML = '';
      for (var i = 0; i < selectedSearchTags.length; i++) {
        var tag = selectedSearchTags[i];
        var el = document.createElement('div');
        el.className = 'search-tag';
        el.style.cssText = getTagStyle(tag);
        el.innerHTML = tag + ' <span class="search-tag-remove" onclick="removeSearchTag(\'' + tag + '\')">×</span>';
        container.appendChild(el);
      }
    }

    function toggleTag(tagName) {
      var index = selectedTags.indexOf(tagName);
      if (index > -1) {
        selectedTags.splice(index, 1);
      } else {
        selectedTags.push(tagName);
      }
      updateTagSelector();
    }

    function updateTagSelector() {
      var options = document.querySelectorAll('#tagSelector .tag-option');
      for (var i = 0; i < options.length; i++) {
        var tagName = options[i].textContent;
        if (selectedTags.indexOf(tagName) > -1) {
          options[i].classList.add('selected');
        } else {
          options[i].classList.remove('selected');
        }
      }
    }

    // ========== AI AUTOFILL FUNCTION ==========
    async function analyzeDocumentWithGemini(file) {
  var aiStatus = document.getElementById('aiStatus');
  aiStatus.className = 'ai-status analyzing';
  aiStatus.textContent = '🤖 Анализирую документ...';

  try {
    var reader = new FileReader();
    var base64Promise = new Promise(function(resolve, reject) {
      reader.onload = function() {
        var base64 = reader.result.split(',')[1];
        resolve(base64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
    
    var base64Data = await base64Promise;
    var mimeType = file.type;

    console.log('📤 Отправляю запрос к Gemini API...');
    console.log('Тип файла:', mimeType);
    console.log('Размер base64:', base64Data.length, 'символов');

    var prompt = 'Проанализируй этот документ и верни JSON со следующими полями:\\n' +
      '- title: краткое название документа (до 50 символов)\\n' +
      '- description: краткое описание (1-2 предложения)\\n' +
      '- category: выбери одну категорию из: Жилье, Финансы, Работа, Идентификация, Медицина\\n' +
      '- tags: массив релевантных тегов из: CAF, CADA, OFPRA, ANEF, France Travail, Credit Mutuel\\n' +
      '- actions: массив важной информации (коды, даты, что нужно сделать)\\n' +
      '- content: краткое резюме основного содержания\\n' +
      'Верни только валидный JSON без дополнительного текста.';

    var response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + GEMINI_API_KEY, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [
            { text: prompt },
            { inline_data: { mime_type: mimeType, data: base64Data } }
          ]
        }]
      })
    });

    console.log('📥 Ответ получен. Статус:', response.status, response.statusText);

    if (!response.ok) {
      var errorText = await response.text();
      console.error('❌ API вернул ошибку:', errorText);
      throw new Error('API Error: ' + response.status + ' - ' + errorText.substring(0, 200));
    }

    var data = await response.json();
    console.log('✅ JSON распарсен:', data);

    if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
      console.error('❌ Неожиданная структура ответа:', data);
      throw new Error('Unexpected API response structure');
    }

    var text = data.candidates[0].content.parts[0].text;
    console.log('📝 Текст ответа от Gemini:', text);
    
    var jsonMatch = text.match(/\\{[\\s\\S]*\\}/);
    if (!jsonMatch) {
      console.error('❌ JSON не найден в ответе');
      throw new Error('No JSON found in response');
    }
    
    var result = JSON.parse(jsonMatch[0]);
    console.log('✅ JSON успешно распарсен:', result);

    document.getElementById('titleInput').value = result.title || '';
    document.getElementById('descInput').value = result.description || '';
    document.getElementById('categorySelect').value = result.category || '';
    document.getElementById('actionsInput').value = result.actions ? result.actions.join('\\n') : '';
    document.getElementById('contentInput').value = result.content || '';

    selectedTags = [];
    if (result.tags && result.tags.length > 0) {
      for (var i = 0; i < result.tags.length; i++) {
        if (PREDEFINED_TAGS.indexOf(result.tags[i]) > -1) {
          selectedTags.push(result.tags[i]);
        }
      }
    }
    updateTagSelector();

    console.log('✅ Форма заполнена успешно!');
    aiStatus.style.display = 'none';
  } catch (error) {
    console.error('❌ AI Error:', error);
    console.error('Полная ошибка:', error.message);
    console.error('Stack trace:', error.stack);
    aiStatus.className = 'ai-status error';
    aiStatus.textContent = '⚠️ Ошибка: ' + error.message;
  }
}
    function loadDocuments() {
      supabase.from('documents').select('*').order('created_at', { ascending: false })
        .then(function(response) {
          if (response.error) throw response.error;
          allDocuments = response.data || [];
          applyFilters();
          updateFilters();
          updateTagSuggestions();
        })
        .catch(function(error) {
          console.error('Ошибка загрузки:', error);
          document.getElementById('previewGrid').innerHTML = '<div class="loading">Ошибка загрузки</div>';
        });
    }

    function applyFilters() {
      var textQuery = document.getElementById('textSearch').value.toLowerCase();
      var categoryFilter = document.getElementById('categoryFilter').value;
      
      var filtered = allDocuments.filter(function(doc) {
        var textMatch = !textQuery || 
          (doc.title && doc.title.toLowerCase().indexOf(textQuery) > -1) ||
          (doc.description && doc.description.toLowerCase().indexOf(textQuery) > -1);
        
        var categoryMatch = !categoryFilter || 
          (doc.categories && doc.categories.indexOf(categoryFilter) > -1);
        
        var tagsMatch = selectedSearchTags.length === 0 || 
          (doc.tags && selectedSearchTags.every(function(tag) {
            return doc.tags.indexOf(tag) > -1;
          }));
        
        return textMatch && categoryMatch && tagsMatch;
      });
      
      renderDocuments(filtered);
    }

    function renderDocuments(documents) {
      var grid = document.getElementById('previewGrid');
      if (documents.length === 0) {
        grid.innerHTML = '<div class="loading">Нет документов</div>';
        return;
      }
      var html = '';
      for (var i = 0; i < documents.length; i++) {
        var doc = documents[i];
        var tagsHtml = '';
        if (doc.tags) {
          for (var j = 0; j < Math.min(doc.tags.length, 3); j++) {
            var tag = doc.tags[j];
            tagsHtml += '<span class="preview-tag" style="' + getTagStyle(tag) + '">' + tag + '</span>';
          }
          if (doc.tags.length > 3) {
            tagsHtml += '<span class="preview-tag" style="background: rgba(114, 228, 160, 0.2); color: #72E4A0;">+' + (doc.tags.length - 3) + '</span>';
          }
        }
        var category = (doc.categories && doc.categories.length > 0) ? doc.categories[0] : '';
        html += '<div class="preview-card" onclick="openDocumentModal(\'' + doc.id + '\')">' +
          '<div class="preview-header">' +
          '<div class="preview-icon">📄</div>' +
          '<div class="preview-info">' +
          '<div class="preview-title">' + (doc.title || 'Без названия') + '</div>' +
          '<div class="preview-category">' + category + '</div>' +
          '</div></div>' +
          '<div class="preview-desc">' + (doc.description || 'Нет описания') + '</div>' +
          '<div class="preview-tags">' + tagsHtml + '</div></div>';
      }
      grid.innerHTML = html;
    }

    function updateFilters() {
      var catCounts = {};
      
      for (var i = 0; i < allDocuments.length; i++) {
        var doc = allDocuments[i];
        if (doc.categories) {
          for (var j = 0; j < doc.categories.length; j++) {
            var cat = doc.categories[j];
            catCounts[cat] = (catCounts[cat] || 0) + 1;
          }
        }
      }

      var catList = document.getElementById('categoriesList');
      var catHtml = '<div class="menu-item active" onclick="clearFilters()">Все документы<span class="item-count">' + allDocuments.length + '</span></div>';
      for (var i = 0; i < PREDEFINED_CATEGORIES.length; i++) {
        var cat = PREDEFINED_CATEGORIES[i];
        var count = catCounts[cat] || 0;
        catHtml += '<div class="menu-item" onclick="quickFilterCategory(\'' + cat + '\')">' + cat + '<span class="item-count">' + count + '</span></div>';
      }
      catList.innerHTML = catHtml;
    }

    function clearFilters() {
      document.getElementById('textSearch').value = '';
      document.getElementById('categoryFilter').value = '';
      selectedSearchTags = [];
      renderSearchTags();
      updateTagSuggestions();
      applyFilters();
    }

    function quickFilterCategory(cat) {
      document.getElementById('categoryFilter').value = cat;
      applyFilters();
    }

    function openUploadModal() {
      selectedTags = [];
      document.getElementById('uploadModal').classList.add('active');
      updateTagSelector();
    }

    function closeUploadModal() {
      document.getElementById('uploadModal').classList.remove('active');
      document.getElementById('uploadForm').reset();
      document.getElementById('selectedFile').textContent = '';
      document.getElementById('aiStatus').style.display = 'none';
      selectedTags = [];
      updateTagSelector();
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
      var file = e.target.files[0];
      if (file) {
        document.getElementById('selectedFile').textContent = 'Выбран: ' + file.name;
        document.getElementById('titleInput').value = file.name.replace(/\.[^/.]+$/, "");
        
        // Запускаем AI-анализ
        analyzeDocumentWithGemini(file);
      }
    });

    document.getElementById('uploadForm').addEventListener('submit', function(e) {
      e.preventDefault();
      var fileInput = document.getElementById('fileInput');
      var file = fileInput.files[0];
      var title = document.getElementById('titleInput').value;
      var description = document.getElementById('descInput').value;
      var category = document.getElementById('categorySelect').value;
      var actionsText = document.getElementById('actionsInput').value;
      var content = document.getElementById('contentInput').value;
      
      var actions = [];
      if (actionsText) {
        var lines = actionsText.split('\n');
        for (var i = 0; i < lines.length; i++) {
          var line = lines[i].trim();
          if (line) actions.push(line);
        }
      }
      
      if (!file || !category) return;

      var uploadBtn = document.getElementById('uploadBtn');
      uploadBtn.disabled = true;
      uploadBtn.textContent = 'Загрузка...';

      var fileName = Date.now() + '_' + file.name;
      supabase.storage.from('documents').upload(fileName, file)
        .then(function(uploadResponse) {
          if (uploadResponse.error) throw uploadResponse.error;
          var urlData = supabase.storage.from('documents').getPublicUrl(fileName);
          return supabase.from('documents').insert([{
            filename: file.name,
            file_url: urlData.data.publicUrl,
            title: title,
            description: description,
            categories: [category],
            tags: selectedTags,
            actions: actions,
            content: content,
            lang: 'ru',
            ai_filled: true
          }]).select();
        })
        .then(function(docResponse) {
          if (docResponse.error) throw docResponse.error;
          alert('Документ загружен!');
          closeUploadModal();
          loadDocuments();
        })
        .catch(function(error) {
          console.error('Ошибка:', error);
          alert('Ошибка: ' + error.message);
        })
        .finally(function() {
          uploadBtn.disabled = false;
          uploadBtn.textContent = 'Загрузить';
        });
    });

    function previewDocument() {
      if (!currentDocument) return;
      
      document.getElementById('previewTitle').textContent = currentDocument.title || 'Без названия';
      var content = document.getElementById('previewContent');
      
      var fileExt = currentDocument.filename.split('.').pop().toLowerCase();
      
      if (fileExt === 'pdf') {
        content.innerHTML = '<iframe src="' + currentDocument.file_url + '#toolbar=1&navpanes=0&scrollbar=1"></iframe>';
      } else if (fileExt === 'jpg' || fileExt === 'jpeg' || fileExt === 'png') {
        content.innerHTML = '<img src="' + currentDocument.file_url + '" alt="' + (currentDocument.title || 'Документ') + '">';
      } else {
        content.innerHTML = '<div class="loading">Предпросмотр недоступен для этого типа файла</div>';
      }
      
      document.getElementById('previewModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closePreview(event) {
      if (!event || event.target.id === 'previewModal') {
        document.getElementById('previewModal').classList.remove('active');
        document.body.style.overflow = 'auto';
      }
    }

    function openDocumentModal(docId) {
      var doc = null;
      for (var i = 0; i < allDocuments.length; i++) {
        if (allDocuments[i].id === docId) {
          doc = allDocuments[i];
          break;
        }
      }
      if (!doc) return;
      currentDocument = doc;
      isEditMode = false;
      renderDocumentCard();
      document.getElementById('modalOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function renderDocumentCard() {
      if (!currentDocument) return;
      var doc = currentDocument;
      
      if (isEditMode) {
        selectedEditTags = doc.tags ? doc.tags.slice() : [];
        var actionsText = (doc.actions && doc.actions.length > 0) ? doc.actions.join('\n') : '';
        
        var content = '<div class="doc-title-edit">' +
          '<input type="text" class="editable-input" id="editTitle" value="' + (doc.title || '') + '" placeholder="Название документа">' +
          '</div>' +
          '<div class="doc-desc-edit">' +
          '<textarea class="editable-input" id="editDesc" placeholder="Описание документа" style="min-height: 60px;">' + (doc.description || '') + '</textarea>' +
          '</div>';

        content += '<div class="doc-fields-row">' +
          '<div class="doc-field-title">Категория:</div>' +
          '<div style="flex: 1;"><select class="editable-input" id="editCategory">';
        for (var i = 0; i < PREDEFINED_CATEGORIES.length; i++) {
          var selected = (doc.categories && doc.categories[0] === PREDEFINED_CATEGORIES[i]) ? ' selected' : '';
          content += '<option value="' + PREDEFINED_CATEGORIES[i] + '"' + selected + '>' + PREDEFINED_CATEGORIES[i] + '</option>';
        }
        content += '</select></div></div>';

        content += '<div class="doc-fields-row">' +
          '<div class="doc-field-title">Теги:</div>' +
          '<div class="tag-selector" id="editTagSelector" style="flex: 1;"></div>' +
          '</div>';

        content += '<div class="doc-fields-row">' +
          '<div class="doc-field-title">Действия:</div>' +
          '<div style="flex: 1;"><textarea class="editable-input" id="editActions" placeholder="Каждое действие с новой строки" style="min-height: 100px;">' + actionsText + '</textarea></div>' +
          '</div>';

        content += '<div class="doc-fields-row">' +
          '<div class="doc-field-title">Содержание:</div>' +
          '<div style="flex: 1;"><textarea class="editable-input" id="editContent" placeholder="Содержание документа" style="min-height: 120px;">' + (doc.content || '') + '</textarea></div>' +
          '</div>';

        content += '<div class="edit-buttons">' +
          '<button class="btn btn-secondary" onclick="cancelEdit()">Отмена</button>' +
          '<button class="btn btn-primary" onclick="saveEdit()">Сохранить</button>' +
          '</div>';

        document.getElementById('modalContent').innerHTML = content;
        populateEditTagSelector();
        
      } else {
        var content = '<div class="doc-title">' + (doc.title || 'Без названия') + '</div>' +
          '<div class="doc-desc">' + (doc.description || 'Нет описания') + '</div>';

        if (doc.categories && doc.categories.length > 0) {
          var catsHtml = '';
          for (var i = 0; i < doc.categories.length; i++) {
            catsHtml += '<span class="doc-tag" style="background: rgba(114, 228, 160, 0.2); color: #72E4A0;">' + doc.categories[i] + '</span>';
          }
          content += '<div class="doc-fields-row"><div class="doc-field-title">Категории:</div><div class="doc-tags">' + catsHtml + '</div></div>';
        }

        if (doc.tags && doc.tags.length > 0) {
          var tagsHtml = '';
          for (var i = 0; i < doc.tags.length; i++) {
            var tag = doc.tags[i];
            tagsHtml += '<span class="doc-tag" style="' + getTagStyle(tag) + '">' + tag + '</span>';
          }
          content += '<div class="doc-fields-row"><div class="doc-field-title">Теги:</div><div class="doc-tags">' + tagsHtml + '</div></div>';
        }

        if (doc.actions && doc.actions.length > 0) {
          var needsCollapse = doc.actions.length > 5;
          var actionsHtml = '<ul class="doc-actions-list' + (needsCollapse ? ' collapsed' : '') + '" id="docActionsList">';
          for (var i = 0; i < doc.actions.length; i++) {
            actionsHtml += '<li>' + doc.actions[i] + '</li>';
          }
          actionsHtml += '</ul>';
          if (needsCollapse) {
            actionsHtml += '<button class="show-more-actions" onclick="toggleActions()">Показать все (' + doc.actions.length + ')</button>';
          }
          content += '<div class="doc-fields-row"><div class="doc-field-title">Действия:</div><div style="flex: 1;">' + actionsHtml + '</div></div>';
        }

        if (doc.content) {
          content += '<div class="doc-fields-row"><div class="doc-field-title">Содержание:</div><div class="doc-content">' + doc.content + '</div></div>';
        }

        content += '<div class="doc-actions-buttons">' +
          '<button class="icon-btn" onclick="previewDocument()" title="Просмотр">👁</button>' +
          '<button class="icon-btn" onclick="editDocument()" title="Редактировать">✎</button>' +
          '<a class="icon-btn" href="' + doc.file_url + '" download="' + doc.filename + '" target="_blank" title="Скачать">↓</a>' +
          '<button class="icon-btn delete" onclick="deleteDocument(\'' + doc.id + '\')" title="Удалить">🗑</button>' +
          '</div>';

        document.getElementById('modalContent').innerHTML = content;
      }

      var langBtns = document.querySelectorAll('.lang-btn');
      for (var i = 0; i < langBtns.length; i++) {
        if (langBtns[i].dataset.lang === doc.lang) {
          langBtns[i].classList.add('active');
        } else {
          langBtns[i].classList.remove('active');
        }
      }
    }

    function editDocument() {
      isEditMode = true;
      renderDocumentCard();
    }

    function cancelEdit() {
      isEditMode = false;
      renderDocumentCard();
    }

    function saveEdit() {
      if (!currentDocument) return;
      
      var title = document.getElementById('editTitle').value;
      var description = document.getElementById('editDesc').value;
      var category = document.getElementById('editCategory').value;
      var actionsText = document.getElementById('editActions').value;
      var content = document.getElementById('editContent').value;
      
      var actions = [];
      if (actionsText) {
        var lines = actionsText.split('\n');
        for (var i = 0; i < lines.length; i++) {
          var line = lines[i].trim();
          if (line) actions.push(line);
        }
      }
      
      if (!category) {
        alert('Выберите категорию');
        return;
      }

      supabase.from('documents').update({
        title: title,
        description: description,
        categories: [category],
        tags: selectedEditTags,
        actions: actions,
        content: content
      }).eq('id', currentDocument.id)
        .then(function(response) {
          if (response.error) throw response.error;
          
          currentDocument.title = title;
          currentDocument.description = description;
          currentDocument.categories = [category];
          currentDocument.tags = selectedEditTags;
          currentDocument.actions = actions;
          currentDocument.content = content;
          
          isEditMode = false;
          renderDocumentCard();
          loadDocuments();
        })
        .catch(function(error) {
          console.error('Ошибка:', error);
          alert('Ошибка: ' + error.message);
        });
    }

    function toggleActions() {
      var list = document.getElementById('docActionsList');
      var btn = event.target;
      if (list.classList.contains('collapsed')) {
        list.classList.remove('collapsed');
        btn.textContent = 'Свернуть';
      } else {
        list.classList.add('collapsed');
        var total = currentDocument.actions.length;
        btn.textContent = 'Показать все (' + total + ')';
      }
    }

    function switchLanguage(targetLang) {
      if (!currentDocument || currentDocument.lang === targetLang) return;
      alert('Перевод временно недоступен. Добавим позже!');
    }

    function deleteDocument(docId) {
      if (!confirm('Удалить документ?')) return;
      var doc = null;
      for (var i = 0; i < allDocuments.length; i++) {
        if (allDocuments[i].id === docId) {
          doc = allDocuments[i];
          break;
        }
      }
      if (!doc) return;

      var fileName = doc.file_url.split('/').pop();
      supabase.storage.from('documents').remove([fileName])
        .then(function() {
          return supabase.from('documents').delete().eq('id', docId);
        })
        .then(function(response) {
          if (response.error) throw response.error;
          alert('Документ удален');
          closeModal();
          loadDocuments();
        })
        .catch(function(error) {
          console.error('Ошибка:', error);
          alert('Ошибка: ' + error.message);
        });
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('active');
      document.body.style.overflow = 'auto';
      currentDocument = null;
      isEditMode = false;
    }

    function closeModalOnOverlay(event) {
      if (event.target.id === 'modalOverlay') {
        closeModal();
      }
    }

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        var previewModal = document.getElementById('previewModal');
        var mainModal = document.getElementById('modalOverlay');
        var uploadModal = document.getElementById('uploadModal');
        
        if (previewModal.classList.contains('active')) {
          closePreview();
        } else if (mainModal.classList.contains('active')) {
          if (isEditMode) {
            cancelEdit();
          } else {
            closeModal();
          }
        } else if (uploadModal.classList.contains('active')) {
          closeUploadModal();
        }
      }
    });

    initializeApp();
  </script>
</body>
</html>
