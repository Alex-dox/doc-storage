<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>DocStorage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />

  <!-- Supabase SDK (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // –¢–í–û–ô –ø—Ä–æ–µ–∫—Ç Supabase
    const SUPABASE_URL = 'https://zudvtnxzwnyxxtgmlenf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp1ZHZ0bnh6d255eHh0Z21sZW5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5MTIzNTAsImV4cCI6MjA3NjQ4ODM1MH0.ZJGsAv6H-rm6NzUrT_jWITvwZbrRDsxLcDSNOIfQzgk';

    // –ï–¥–∏–Ω—ã–π –∫–ª–∏–µ–Ω—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–ª–µ–µ –∫–∞–∫ `supabase`)
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ä–∞–Ω–Ω–∏—Ö –æ—à–∏–±–æ–∫
    window.addEventListener('error', e => console.error('Runtime error:', e.error || e.message));
    window.addEventListener('unhandledrejection', e => console.error('Unhandled:', e.reason));
  </script>

  <style>
    * { box-sizing: border-box; }
    body { font-family:'Inter',-apple-system,sans-serif; background:#181A1B; color:#F3F6F8; margin:0; display:flex; height:100vh; }
    aside { width:260px; background:#202225; display:flex; flex-direction:column; padding:24px 16px; border-right:1px solid #2a2d2f; overflow-y:auto; }
    .menu-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;}
    .menu-logo{font-weight:600;font-size:20px;color:#72E4A0;}
    .add-icon-btn{width:32px;height:32px;background:#72E4A0;color:#181A1B;border:none;border-radius:6px;font-size:20px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s;line-height:1;}
    .add-icon-btn:hover{background:#4BC483;transform:scale(1.05);}
    .section-header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px;}
    .gear-btn{width:26px;height:26px;border:none;border-radius:6px;background:#2a2d2f;color:#B6BABF;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;font-size:14px;transition:.2s;}
    .gear-btn:hover{background:#3a3d3f;color:#F3F6F8;}
    .search-section{margin-bottom:20px;}
    .search-label{font-size:11px;color:#74cba4;font-weight:600;text-transform:uppercase;}
    .and-toggle{display:flex;align-items:center;gap:8px;font-size:12px;color:#B6BABF;user-select:none;}
    .search-input{width:100%;background:#2a2d2f;border:1px solid #3a3d3f;border-radius:8px;padding:10px 12px;color:#F3F6F8;font-size:14px;margin-bottom:10px;}
    .search-input:focus{outline:none;border-color:#72E4A0;}
    .search-tags-container{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;}
    .search-tag{padding:4px 8px;border-radius:6px;font-size:12px;display:flex;align-items:center;gap:4px;cursor:pointer;}
    .search-tag-remove{font-weight:bold;opacity:.7;}
    .search-tag-remove:hover{opacity:1;}
    .tag-suggestions{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px;}
    .tag-suggestion{padding:3px 8px;border-radius:6px;font-size:11px;cursor:pointer;transition:opacity .2s;}
    .tag-suggestion:hover{opacity:.8;}
    .menu-section{margin-bottom:24px;}
    .menu-section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
    .menu-title{font-size:12px;text-transform:uppercase;color:#74cba4;font-weight:600;}
    .menu-item{padding:8px 12px;border-radius:8px;cursor:pointer;transition:background .2s;font-size:14px;color:#B6BABF;margin-bottom:4px;display:flex;align-items:center;justify-content:space-between;}
    .menu-item:hover{background:#2a2d2f;color:#F3F6F8;}
    .menu-item.active{background:rgba(114,228,160,.15);color:#72E4A0;}
    .item-count{font-size:12px;color:#6a6d6f;background:#2a2d2f;padding:2px 6px;border-radius:4px;}
    main{flex:1;display:flex;flex-direction:column;padding:32px 40px;overflow-y:auto;}
    .main-header{margin-bottom:24px;}
    .main-title{font-size:28px;font-weight:600;margin:0 0 8px 0;}
    .main-subtitle{font-size:15px;color:#B6BABF;}
    .preview-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px;}
    .preview-card{background:#212324;border-radius:12px;padding:20px;cursor:pointer;transition:.2s;border:2px solid transparent;}
    .preview-card:hover{border-color:#72E4A0;transform:translateY(-2px);box-shadow:0 4px 12px rgba(114,228,160,.15);}
    .preview-header{display:flex;gap:12px;margin-bottom:12px;}
    .preview-icon{width:48px;height:48px;background:#2a2d2f;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;}
    .preview-info{flex:1;min-width:0;}
    .preview-title{font-size:16px;font-weight:600;margin-bottom:4px;color:#F3F6F8;line-height:1.3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .preview-category{font-size:12px;color:#74cba4;font-weight:500;}
    .preview-desc{font-size:13px;color:#B6BABF;line-height:1.5;margin-bottom:12px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
    .preview-tags{display:flex;gap:6px;flex-wrap:wrap;}
    .preview-tag{font-size:11px;border-radius:6px;padding:3px 8px;}
    .upload-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(24,26,27,.85);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:1000;padding:40px;overflow-y:auto;}
    .upload-modal.active{display:flex;}
    .upload-form{background:#212324;border-radius:16px;max-width:600px;width:100%;padding:32px 28px;max-height:90vh;overflow-y:auto;}
    .upload-form h2{margin:0 0 24px 0;font-size:22px;color:#F3F6F8;}
    .form-group{margin-bottom:20px;}
    .form-group label{display:block;margin-bottom:8px;color:#74cba4;font-size:14px;font-weight:500;}
    .form-group input[type="text"],.form-group textarea,.form-group select{width:100%;background:#2a2d2f;border:1px solid #3a3d3f;border-radius:8px;padding:10px 12px;color:#F3F6F8;font-size:14px;}
    .form-group textarea{resize:vertical;min-height:80px;}
    .file-input-wrapper{position:relative;background:#2a2d2f;border:2px dashed #72E4A0;border-radius:8px;padding:30px;text-align:center;cursor:pointer;transition:.2s;}
    .file-input-wrapper:hover{background:#323537;border-color:#4BC483;}
    .file-input-wrapper input[type="file"]{position:absolute;opacity:0;width:100%;height:100%;top:0;left:0;cursor:pointer;}
    .file-input-label{color:#B6BABF;font-size:14px;}
    .selected-file{margin-top:12px;color:#72E4A0;font-size:13px;}
    .ai-status{margin-top:12px;padding:10px 12px;border-radius:8px;font-size:13px;display:none;}
    .ai-status.analyzing{display:block;background:rgba(114,228,160,.1);color:#72E4A0;border:1px solid rgba(114,228,160,.3);}
    .ai-status.error{display:block;background:rgba(255,159,64,.1);color:#ff9f40;border:1px solid rgba(255,159,64,.3);}
    .tag-selector{display:flex;flex-wrap:wrap;gap:8px;padding:12px;background:#2a2d2f;border:1px solid #3a3d3f;border-radius:8px;max-height:200px;overflow-y:auto;}
    .tag-option{background:rgba(114,228,160,.1);color:#72E4A0;padding:6px 12px;border-radius:6px;font-size:13px;cursor:pointer;transition:.2s;border:1px solid transparent;}
    .tag-option:hover{background:rgba(114,228,160,.2);}
    .tag-option.selected{background:rgba(114,228,160,.25);border-color:#72E4A0;}
    .help-text{font-size:12px;color:#6a6d6f;margin-top:4px;}
    .form-buttons{display:flex;gap:12px;margin-top:24px;}
    .btn{flex:1;padding:12px 24px;border:none;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;transition:.2s;}
    .btn-primary{background:#72E4A0;color:#181A1B;}
    .btn-primary:hover{background:#4BC483;}
    .btn-primary:disabled{background:#3a3d3f;color:#6a6d6f;cursor:not-allowed;}
    .btn-secondary{background:transparent;color:#B6BABF;border:1px solid #3a3d3f;}
    .btn-secondary:hover{background:#2a2d2f;}
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(24,26,27,.85);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:1000;padding:40px;}
    .modal-overlay.active{display:flex;}
    .modal-card{background:#212324;border-radius:16px;max-width:700px;width:100%;max-height:90vh;overflow-y:auto;position:relative;padding:32px 28px 28px;animation:modalSlideIn .3s ease;}
    @keyframes modalSlideIn{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
    .close-btn{position:absolute;top:20px;right:20px;width:32px;height:32px;border:none;background:#2a2d2f;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s;color:#B6BABF;font-size:20px;z-index:10;}
    .close-btn:hover{background:#72E4A0;color:#181A1B;}
    .preview-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(24,26,27,.95);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:2000;padding:40px;}
    .preview-modal.active{display:flex;}
    .preview-container{background:#212324;border-radius:16px;max-width:90vw;max-height:90vh;width:100%;height:100%;position:relative;display:flex;flex-direction:column;overflow:hidden;}
    .preview-header{padding:20px 24px;border-bottom:1px solid #2a2d2f;display:flex;align-items:center;justify-content:space-between;}
    .preview-title-text{font-size:18px;font-weight:600;color:#F3F6F8;}
    .preview-content{flex:1;overflow:auto;display:flex;align-items:center;justify-content:center;padding:20px;}
    .preview-content iframe{width:100%;height:100%;border:none;border-radius:8px;}
    .preview-content img{max-width:100%;max-height:100%;object-fit:contain;border-radius:8px;}
    .loading{text-align:center;padding:40px;color:#B6BABF;}

    /* –î–æ–∫-–∫–∞—Ä—Ç–∞ */
    .settings-list{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:8px;background:#2a2d2f;color:#DEE6EA;font-size:13px;}
    .chip button{border:none;background:transparent;color:#ff6b6b;font-size:14px;cursor:pointer;padding:0 2px;}

    .doc-title{font-size:20px;font-weight:600;margin:0 0 8px 0;color:#F3F6F8;}
    .doc-desc{font-size:13px;color:#B6BABF;line-height:1.6;margin-bottom:8px;}
    .doc-section{padding:12px 0;border-top:1px solid #2a2d2f;}
    .doc-section:first-of-type{border-top:none;padding-top:0;}
    .section-label{font-size:11px;text-transform:uppercase;letter-spacing:.04em;color:#74cba4;font-weight:600;margin-bottom:8px;}
    .doc-tags{display:flex;flex-wrap:wrap;gap:6px;}
    .doc-tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:8px;font-size:12px;background:#2a2d2f;color:#DEE6EA;border:1px solid #3a3d3f;}
    .doc-actions-list{margin:0;padding-left:18px;}
    .doc-actions-list.collapsed li:nth-child(n+6){display:none;}
    .show-more-actions{margin-top:8px;background:#2a2d2f;border:1px solid #3a3d3f;color:#B6BABF;border-radius:8px;padding:8px 10px;cursor:pointer;}
    .show-more-actions:hover{background:#303335;color:#F3F6F8;}
    .doc-actions-bar{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;}
    .icon-btn{width:36px;height:36px;border-radius:8px;border:1px solid #3a3d3f;background:#2a2d2f;color:#B6BABF;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;transition:.2s;}
    .icon-btn:hover{background:#303335;color:#F3F6F8;}
    .icon-btn.delete:hover{border-color:#ff6b6b;color:#ff6b6b;}
    .icon{width:18px;height:18px;display:block;}
  </style>
</head>
<body>
  <aside>
    <div class="menu-header">
      <div class="menu-logo">DocStorage</div>
      <button class="add-icon-btn" onclick="openUploadModal()">+</button>
    </div>

    <div class="search-section">
      <div class="search-label">–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É</div>
      <input type="text" class="search-input" id="textSearch" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ..." />
    </div>

    <div class="search-section">
      <div class="section-header">
        <div class="search-label">–¢–µ–≥–∏</div>
        <button class="gear-btn" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞–º–∏" onclick="openSettings('tags')">
          <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 8.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7Z" stroke="currentColor" stroke-width="1.6"/><path d="M4 12c0-.5.05-1 .15-1.47l-1.9-1.1 2-3.46 1.9 1.1c.7-.56 1.5-1 2.36-1.3V3h4v2.77c.86.3 1.66.74 2.36 1.3l1.9-1.1 2 3.46-1.9 1.1c.1.47.15.97.15 1.47s-.05 1-.15 1.47l1.9 1.1-2 3.46-1.9-1.1c-.7.56-1.5 1-2.36 1.3V21h-4v-2.77c-.86-.3-1.66-.74-2.36-1.3l-1.9 1.1-2-3.46 1.9-1.1c-.1-.47-.15-.97-.15-1.47Z" stroke="currentColor" stroke-width="1.6"/></svg>
        </button>
      </div>
      <div class="search-tags-container" id="selectedSearchTags"></div>
      <div class="tag-suggestions" id="tagSuggestions"></div>
      <label class="and-toggle"><input type="checkbox" id="tagsAndMode" /> –í—Å–µ —Ç–µ–≥–∏</label>
    </div>

    <div class="search-section">
      <div class="section-header">
        <div class="search-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
        <button class="gear-btn" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏" onclick="openSettings('categories')">
          <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 8.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7Z" stroke="currentColor" stroke-width="1.6"/><path d="M4 12c0-.5.05-1 .15-1.47l-1.9-1.1 2-3.46 1.9 1.1c.7-.56 1.5-1 2.36-1.3V3h4v2.77c.86.3 1.66.74 2.36 1.3l1.9-1.1 2 3.46-1.9 1.1c.1.47.15.97.15 1.47s-.05 1-.15 1.47l1.9 1.1-2 3.46-1.9-1.1c-.7.56-1.5 1-2.36 1.3V21h-4v-2.77c-.86-.3-1.66-.74-2.36-1.3l-1.9 1.1-2-3.46 1.9-1.1c-.1-.47-.15-.97-.15-1.47Z" stroke="currentColor" stroke-width="1.6"/></svg>
        </button>
      </div>
      <select class="search-input" id="categoryFilter">
        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
      </select>
    </div>
  </aside>

  <main>
    <div class="main-header">
      <h1 class="main-title" id="mainTitle">–í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</h1>
      <p class="main-subtitle">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π</p>
    </div>
    <div class="preview-grid" id="previewGrid">
      <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤...</div>
    </div>
  </main>

  <!-- Upload -->
  <div class="upload-modal" id="uploadModal">
    <div class="upload-form">
      <h2>–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</h2>
      <form id="uploadForm">
        <div class="form-group">
          <label>–§–∞–π–ª *</label>
          <div class="file-input-wrapper">
            <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png" required />
            <div class="file-input-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª (PDF, JPEG, PNG)</div>
            <div class="selected-file" id="selectedFile"></div>
            <div class="ai-status" id="aiStatus"></div>
          </div>
        </div>

        <div class="form-group">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
          <input type="text" id="titleInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞" required />
        </div>

        <div class="form-group">
          <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="descInput" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞"></textarea>
        </div>

        <div class="form-group">
          <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
          <select id="categorySelect" required>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
          </select>
        </div>

        <div class="form-group">
          <label>–¢–µ–≥–∏</label>
          <div class="tag-selector" id="tagSelector"></div>
          <div class="help-text">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ç–µ–≥–∏</div>
        </div>

        <div class="form-group">
          <label>–î–µ–π—Å—Ç–≤–∏—è (–≤–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –∫–æ–¥—ã, –¥–∞—Ç—ã, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å)</label>
          <textarea id="actionsInput" placeholder="–ö–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä:&#10;–ö–æ–¥: 123456&#10;–°—Ä–æ–∫: 1 –Ω–æ—è–±—Ä—è 2025&#10;–û–ø–ª–∞—Ç–∏—Ç—å —Å—á–µ—Ç"></textarea>
        </div>

        <div class="form-group">
          <label>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</label>
          <textarea id="contentInput" placeholder="–û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞" style="min-height:120px;"></textarea>
        </div>

        <div class="form-buttons">
          <button type="button" class="btn btn-secondary" onclick="closeUploadModal()">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn btn-primary" id="uploadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <!-- –î–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∞ -->
  <div class="modal-overlay" id="modalOverlay" onclick="closeModalOnOverlay(event)">
    <div class="modal-card" onclick="event.stopPropagation()">
      <button class="close-btn" onclick="closeModal()">√ó</button>
      <div id="modalContent"></div>
    </div>
  </div>

  <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
  <div class="modal-overlay" id="settingsOverlay" onclick="closeSettingsOnOverlay(event)">
    <div class="modal-card" onclick="event.stopPropagation()">
      <button class="close-btn" onclick="closeSettings()">√ó</button>
      <h2 id="settingsTitle" style="margin-top:0;color:#F3F6F8;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
      <div id="settingsContent"></div>
    </div>
  </div>

  <!-- –ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–∞ -->
  <div class="preview-modal" id="previewModal" onclick="closePreview(event)">
    <div class="preview-container" onclick="event.stopPropagation()">
      <div class="preview-header">
        <div class="preview-title-text" id="previewTitle">–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞</div>
        <button class="close-btn" onclick="closePreview()">√ó</button>
      </div>
      <div class="preview-content" id="previewContent">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    </div>
  </div>

  <script>
    // ==== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ====
    const DEFAULT_CATEGORIES = ['–ñ–∏–ª—å–µ','–§–∏–Ω–∞–Ω—Å—ã','–†–∞–±–æ—Ç–∞','–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è','–ú–µ–¥–∏—Ü–∏–Ω–∞'];
    const DEFAULT_TAGS = ['CAF','CADA','OFPRA','ANEF','France Travail','Credit Mutuel'];
    const TAG_COLORS = {
      'CAF':'background: rgba(255,99,132,.2); color:#ff6384;',
      'CADA':'background: rgba(54,162,235,.2); color:#36a2eb;',
      'OFPRA':'background: rgba(255,206,86,.2); color:#ffce56;',
      'ANEF':'background: rgba(75,192,192,.2); color:#4bc0c0;',
      'France Travail':'background: rgba(153,102,255,.2); color:#9966ff;',
      'Credit Mutuel':'background: rgba(255,159,64,.2); color:#ff9f40;'
    };

    // ==== –°–æ—Å—Ç–æ—è–Ω–∏–µ ====
    let PREDEFINED_CATEGORIES = [];
    let PREDEFINED_TAGS = [];
    let allDocuments = [];
    let currentDocument = null;
    let selectedTags = [];
    let selectedEditTags = [];
    let selectedSearchTags = [];
    let isEditMode = false;

    // ==== –£—Ç–∏–ª–∏—Ç—ã ====
    function getTagStyle(tag){ return TAG_COLORS[tag] || 'background: rgba(114,228,160,.2); color:#72E4A0;'; }

    // ==== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ====
    async function loadTaxonomy(){
      try{
        const { data, error } = await supabase
          .from('taxonomy').select('categories,tags')
          .eq('slug','global')
          .single();
        if(error) throw error;
        PREDEFINED_CATEGORIES = Array.isArray(data?.categories) && data.categories.length ? data.categories.slice() : DEFAULT_CATEGORIES.slice();
        PREDEFINED_TAGS = Array.isArray(data?.tags) && data.tags.length ? data.tags.slice() : DEFAULT_TAGS.slice();
      }catch(e){
        console.warn('loadTaxonomy fallback:', e?.message || e);
        PREDEFINED_CATEGORIES = DEFAULT_CATEGORIES.slice();
        PREDEFINED_TAGS = DEFAULT_TAGS.slice();
      }
    }

    async function loadDocuments(){
      try{
        const { data, error } = await supabase
          .from('documents')
          .select('*')
          .order('created_at',{ascending:false});
        if(error) throw error;
        allDocuments = data || [];
        applyFilters();
        updateFilters();
        updateTagSuggestions();
      }catch(e){
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
        document.getElementById('previewGrid').innerHTML = '<div class="loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
      }
    }

    async function initializeApp(){
      await loadTaxonomy();
      populateCategorySelect();
      populateCategoryFilter();
      populateTagSelector();
      updateTagSuggestions();
      await loadDocuments();

      document.getElementById('textSearch').addEventListener('input', applyFilters);
      document.getElementById('categoryFilter').addEventListener('change', applyFilters);
      document.getElementById('tagsAndMode').addEventListener('change', applyFilters);

      initRealtime();
    }

    // ==== UI –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ ====
    function populateCategorySelect(){
      const select = document.getElementById('categorySelect');
      select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
      PREDEFINED_CATEGORIES.forEach(c=>{
        const o=document.createElement('option'); o.value=c; o.textContent=c; select.appendChild(o);
      });
    }
    function populateCategoryFilter(){
      const select = document.getElementById('categoryFilter');
      const current = select.value || '';
      select.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';
      PREDEFINED_CATEGORIES.forEach(c=>{
        const o=document.createElement('option'); o.value=c; o.textContent=c; select.appendChild(o);
      });
      if(current && PREDEFINED_CATEGORIES.includes(current)) select.value=current;
    }
    function populateTagSelector(){
      const wrap = document.getElementById('tagSelector');
      wrap.innerHTML = '';
      PREDEFINED_TAGS.forEach(t=>{
        const el = document.createElement('div');
        el.className='tag-option'; el.textContent=t;
        el.onclick=()=>toggleTag(t);
        wrap.appendChild(el);
      });
      updateTagSelector();
    }
    function populateEditTagSelector(){
      const wrap = document.getElementById('editTagSelector');
      if(!wrap) return;
      wrap.innerHTML='';
      PREDEFINED_TAGS.forEach(t=>{
        const el=document.createElement('div');
        el.className='tag-option'; el.textContent=t;
        if(selectedEditTags.includes(t)) el.classList.add('selected');
        el.onclick=()=>toggleEditTag(t);
        wrap.appendChild(el);
      });
    }
    function toggleTag(t){ const i=selectedTags.indexOf(t); if(i>-1) selectedTags.splice(i,1); else selectedTags.push(t); updateTagSelector(); }
    function updateTagSelector(){
      document.querySelectorAll('#tagSelector .tag-option').forEach(el=>{
        const t=el.textContent; el.classList.toggle('selected', selectedTags.includes(t));
      });
    }
    function toggleEditTag(t){ const i=selectedEditTags.indexOf(t); if(i>-1) selectedEditTags.splice(i,1); else selectedEditTags.push(t); populateEditTagSelector(); }

    // ==== –ü–æ–∏—Å–∫/—Ñ–∏–ª—å—Ç—Ä—ã ====
    function addSearchTag(tag){ if(!selectedSearchTags.includes(tag)){ selectedSearchTags.push(tag); renderSearchTags(); updateTagSuggestions(); applyFilters(); } }
    function removeSearchTag(tag){ const i=selectedSearchTags.indexOf(tag); if(i>-1){ selectedSearchTags.splice(i,1); renderSearchTags(); updateTagSuggestions(); applyFilters(); } }
    function renderSearchTags(){
      const c=document.getElementById('selectedSearchTags'); c.innerHTML='';
      selectedSearchTags.forEach(tag=>{
        const el=document.createElement('div'); el.className='search-tag'; el.style.cssText=getTagStyle(tag);
        el.innerHTML = `${tag} <span class="search-tag-remove" onclick="removeSearchTag('${tag}')">√ó</span>`;
        c.appendChild(el);
      });
    }
    function updateTagSuggestions(){
      let all=[];
      allDocuments.forEach(d=> (d.tags||[]).forEach(t=>{ if(!all.includes(t)&&!selectedSearchTags.includes(t)) all.push(t); }));
      if(all.length===0) PREDEFINED_TAGS.forEach(t=>{ if(!selectedSearchTags.includes(t)) all.push(t); });
      const c=document.getElementById('tagSuggestions'); c.innerHTML='';
      all.slice(0,6).forEach(t=>{
        const el=document.createElement('div'); el.className='tag-suggestion'; el.textContent=t; el.style.cssText=getTagStyle(t); el.onclick=()=>addSearchTag(t); c.appendChild(el);
      });
    }
    function applyFilters(){
      const q=(document.getElementById('textSearch').value||'').toLowerCase();
      const cat=document.getElementById('categoryFilter').value;
      const andMode=document.getElementById('tagsAndMode').checked;

      const filtered = allDocuments.filter(doc=>{
        const textMatch=!q || (doc.title&&doc.title.toLowerCase().includes(q)) || (doc.description&&doc.description.toLowerCase().includes(q));
        const catMatch=!cat || ((doc.categories||[]).includes(cat));
        let tagsMatch=true;
        if(selectedSearchTags.length){
          const tags=doc.tags||[];
          tagsMatch = andMode ? selectedSearchTags.every(t=>tags.includes(t)) : selectedSearchTags.some(t=>tags.includes(t));
        }
        return textMatch && catMatch && tagsMatch;
      });

      renderDocuments(filtered);
    }
    function renderDocuments(list){
      const grid=document.getElementById('previewGrid');
      if(!list.length){ grid.innerHTML='<div class="loading">–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</div>'; return; }
      grid.innerHTML = list.map(doc=>{
        const tags=(doc.tags||[]).slice(0,3).map(t=>`<span class="preview-tag" style="${getTagStyle(t)}">${t}</span>`).join('') +
                      ((doc.tags||[]).length>3?`<span class="preview-tag" style="background: rgba(114,228,160,.2); color:#72E4A0;">+${(doc.tags.length-3)}</span>`:'');
        const cat=(doc.categories&&doc.categories[0])||'';
        return `
          <div class="preview-card" onclick="openDocumentModal('${doc.id}')">
            <div class="preview-header">
              <div class="preview-icon">üìÑ</div>
              <div class="preview-info">
                <div class="preview-title">${doc.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                <div class="preview-category">${cat}</div>
              </div>
            </div>
            <div class="preview-desc">${doc.description||'–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
            <div class="preview-tags">${tags}</div>
          </div>`;
      }).join('');
    }
    function updateFilters(){
      const catList=document.getElementById('categoriesList'); if(!catList) return;
      const counts={};
      allDocuments.forEach(d=>(d.categories||[]).forEach(c=>counts[c]=(counts[c]||0)+1));
      let html=`<div class="menu-item active" onclick="clearFilters()">–í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã<span class="item-count">${allDocuments.length}</span></div>`;
      PREDEFINED_CATEGORIES.forEach(c=>{ html+=`<div class="menu-item" onclick="quickFilterCategory('${c}')">${c}<span class="item-count">${counts[c]||0}</span></div>`; });
      catList.innerHTML=html;
    }
    function clearFilters(){ document.getElementById('textSearch').value=''; document.getElementById('categoryFilter').value=''; document.getElementById('tagsAndMode').checked=false; selectedSearchTags=[]; renderSearchTags(); updateTagSuggestions(); applyFilters(); }
    function quickFilterCategory(c){ document.getElementById('categoryFilter').value=c; applyFilters(); }

    // ==== –ú–æ–¥–∞–ª–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ ====
    function openUploadModal(){ selectedTags=[]; document.getElementById('uploadModal').classList.add('active'); updateTagSelector(); }
    function closeUploadModal(){ document.getElementById('uploadModal').classList.remove('active'); document.getElementById('uploadForm').reset(); document.getElementById('selectedFile').textContent=''; document.getElementById('aiStatus').style.display='none'; selectedTags=[]; updateTagSelector(); }

    // ==== AI –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ ====
    const GEMINI_API_KEY = 'AIzaSyBqGYEAw2ZMr-n-GG2EoyEZlkRyMtQl8bs';
    async function analyzeDocumentWithGemini(file){
      const aiStatus=document.getElementById('aiStatus');
      aiStatus.className='ai-status analyzing'; aiStatus.textContent='ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –¥–æ–∫—É–º–µ–Ω—Ç...';
      try{
        const base64 = await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result.split(',')[1]); r.onerror=rej; r.readAsDataURL(file); });
        const prompt = '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –∏ –≤–µ—Ä–Ω–∏ JSON —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–æ–ª—è–º–∏:\n- title...\n- description...\n- category –∏–∑: '+PREDEFINED_CATEGORIES.join(', ')+'\n- tags –∏–∑: '+PREDEFINED_TAGS.join(', ')+'\n- actions[]\n- content\n–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.';
        const resp = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key='+GEMINI_API_KEY, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ contents:[{ parts:[{text:prompt},{ inline_data:{ mime_type:file.type, data:base64 } }]}] })
        });
        if(!resp.ok) throw new Error('API Error');
        const data = await resp.json();
        const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
        const json = JSON.parse((text.match(/\{[\s\S]*\}/)||['{}'])[0]);
        document.getElementById('titleInput').value = json.title || '';
        document.getElementById('descInput').value = json.description || '';
        document.getElementById('categorySelect').value = json.category || '';
        document.getElementById('actionsInput').value = (json.actions||[]).join('\n');
        document.getElementById('contentInput').value = json.content || '';
        selectedTags = (json.tags||[]).filter(t=>PREDEFINED_TAGS.includes(t));
        updateTagSelector();
        aiStatus.style.display='none';
      }catch(e){
        console.error('AI Error:', e);
        aiStatus.className='ai-status error'; aiStatus.textContent='‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Ä—É—á–Ω—É—é';
      }
    }

    // ==== –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤/—Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ====
    document.getElementById('fileInput').addEventListener('change', e=>{
      const file=e.target.files[0];
      if(file){
        document.getElementById('selectedFile').textContent='–í—ã–±—Ä–∞–Ω: '+file.name;
        document.getElementById('titleInput').value=file.name.replace(/\.[^/.]+$/,'');
        analyzeDocumentWithGemini(file);
      }
    });

    document.getElementById('uploadForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const file = document.getElementById('fileInput').files[0];
      const title = document.getElementById('titleInput').value;
      const description = document.getElementById('descInput').value;
      const category = document.getElementById('categorySelect').value;
      const actionsText = document.getElementById('actionsInput').value;
      const contentText = document.getElementById('contentInput').value;
      if(!file || !category) return;

      const actions = actionsText ? actionsText.split('\n').map(s=>s.trim()).filter(Boolean) : [];
      const btn = document.getElementById('uploadBtn'); btn.disabled=true; btn.textContent='–ó–∞–≥—Ä—É–∑–∫–∞...';
      try{
        const fileName = Date.now()+'_'+file.name;
        const up = await supabase.storage.from('documents').upload(fileName, file);
        if(up.error) throw up.error;
        const { data:pub } = supabase.storage.from('documents').getPublicUrl(fileName);
        const ins = await supabase.from('documents').insert([{
          filename:file.name, file_url:pub.publicUrl, title, description,
          categories:[category], tags:selectedTags, actions, content:contentText, lang:'ru', ai_filled:true
        }]).select();
        if(ins.error) throw ins.error;
        alert('–î–æ–∫—É–º–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω!');
        closeUploadModal();
        loadDocuments();
      }catch(e){ console.error('–û—à–∏–±–∫–∞:', e); alert('–û—à–∏–±–∫–∞: '+e.message); }
      finally{ btn.disabled=false; btn.textContent='–ó–∞–≥—Ä—É–∑–∏—Ç—å'; }
    });

    // ==== –ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ====
    function previewDocument(){
      if(!currentDocument) return;
      document.getElementById('previewTitle').textContent=currentDocument.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
      const c=document.getElementById('previewContent');
      const ext=(currentDocument.filename.split('.').pop()||'').toLowerCase();
      if(ext==='pdf'){ c.innerHTML=`<iframe src="${currentDocument.file_url}#toolbar=1&navpanes=0&scrollbar=1"></iframe>`; }
      else if(['jpg','jpeg','png'].includes(ext)){ c.innerHTML=`<img src="${currentDocument.file_url}" alt="${currentDocument.title||'–î–æ–∫—É–º–µ–Ω—Ç'}">`; }
      else { c.innerHTML='<div class="loading">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞</div>'; }
      document.getElementById('previewModal').classList.add('active'); document.body.style.overflow='hidden';
    }
    function closePreview(e){ if(!e || e.target.id==='previewModal'){ document.getElementById('previewModal').classList.remove('active'); document.body.style.overflow='auto'; } }

    function openDocumentModal(id){
      currentDocument = allDocuments.find(d=>d.id===id); if(!currentDocument) return;
      isEditMode=false; renderDocumentCard();
      document.getElementById('modalOverlay').classList.add('active'); document.body.style.overflow='hidden';
    }
    function closeModal(){ document.getElementById('modalOverlay').classList.remove('active'); document.body.style.overflow='auto'; currentDocument=null; isEditMode=false; }
    function closeModalOnOverlay(e){ if(e.target.id==='modalOverlay') closeModal(); }

    function renderDocumentCard(){
      if(!currentDocument) return;
      const doc=currentDocument;
      if(isEditMode){
        selectedEditTags = (doc.tags||[]).slice();
        const actionsText = (doc.actions||[]).join('\n');
        let html = `
          <div class="doc-title-edit"><input type="text" class="editable-input" id="editTitle" value="${doc.title||''}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞"></div>
          <div class="doc-desc-edit"><textarea class="editable-input" id="editDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞" style="min-height:60px;">${doc.description||''}</textarea></div>
          <div class="doc-fields-row"><div class="doc-field-title">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</div><div style="flex:1;"><select class="editable-input" id="editCategory">
            ${PREDEFINED_CATEGORIES.map(c=>`<option value="${c}" ${doc.categories&&doc.categories[0]===c?'selected':''}>${c}</option>`).join('')}
          </select></div></div>
          <div class="doc-fields-row"><div class="doc-field-title">–¢–µ–≥–∏:</div><div class="tag-selector" id="editTagSelector" style="flex:1;"></div></div>
          <div class="doc-fields-row"><div class="doc-field-title">–î–µ–π—Å—Ç–≤–∏—è:</div><div style="flex:1;"><textarea class="editable-input" id="editActions" placeholder="–ö–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏" style="min-height:100px;">${actionsText}</textarea></div></div>
          <div class="doc-fields-row"><div class="doc-field-title">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:</div><div style="flex:1;"><textarea class="editable-input" id="editContent" placeholder="–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞" style="min-height:120px;">${doc.content||''}</textarea></div></div>
          <div class="edit-buttons"><button class="btn btn-secondary" onclick="cancelEdit()">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-primary" onclick="saveEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>`;
        document.getElementById('modalContent').innerHTML=html;
        populateEditTagSelector();
      }else{
        let catsHtml=(doc.categories||[]).map(c=>`<span class="doc-tag">${c}</span>`).join('');
        let tagsHtml=(doc.tags||[]).map(t=>`<span class="doc-tag" style="${getTagStyle(t)}border-color:transparent;">${t}</span>`).join('');
        let actionsHtml='';
        if(doc.actions?.length){
          const collapse = doc.actions.length>5;
          actionsHtml = `<ul class="doc-actions-list${collapse?' collapsed':''}" id="docActionsList">${doc.actions.map(a=>`<li>${a}</li>`).join('')}</ul>`+
                        (collapse?`<button class="show-more-actions" onclick="toggleActions()">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ (${doc.actions.length})</button>`:'');
        }
        let html = `
          <div class="doc-title">${doc.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
          ${doc.description?`<div class="doc-desc">${doc.description}</div>`:''}
          ${(doc.categories?.length)?`<div class="doc-section"><div class="section-label">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div><div class="doc-tags">${catsHtml}</div></div>`:''}
          ${(doc.tags?.length)?`<div class="doc-section"><div class="section-label">–¢–µ–≥–∏</div><div class="doc-tags">${tagsHtml}</div></div>`:''}
          ${(doc.actions?.length)?`<div class="doc-section"><div class="section-label">–î–µ–π—Å—Ç–≤–∏—è</div>${actionsHtml}</div>`:''}
          ${doc.content?`<div class="doc-section"><div class="section-label">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</div><div class="doc-content">${doc.content}</div></div>`:''}
          <div class="doc-actions-bar">
            <button class="icon-btn" onclick="previewDocument()" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">üîé</button>
            <button class="icon-btn" onclick="editDocument()" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
            <a class="icon-btn" href="${doc.file_url}" download="${doc.filename}" target="_blank" title="–°–∫–∞—á–∞—Ç—å">‚¨áÔ∏è</a>
            <button class="icon-btn delete" onclick="deleteDocument('${doc.id}')" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
          </div>`;
        document.getElementById('modalContent').innerHTML=html;
      }
    }
    function editDocument(){ isEditMode=true; renderDocumentCard(); }
    function cancelEdit(){ isEditMode=false; renderDocumentCard(); }
    async function saveEdit(){
      if(!currentDocument) return;
      const title=document.getElementById('editTitle').value;
      const description=document.getElementById('editDesc').value;
      const category=document.getElementById('editCategory').value;
      const actionsText=document.getElementById('editActions').value;
      const content=document.getElementById('editContent').value;
      if(!category){ alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é'); return; }
      const actions = actionsText ? actionsText.split('\n').map(s=>s.trim()).filter(Boolean) : [];
      const { error } = await supabase.from('documents').update({
        title, description, categories:[category], tags:selectedEditTags, actions, content
      }).eq('id', currentDocument.id);
      if(error){ alert('–û—à–∏–±–∫–∞: '+error.message); return; }
      Object.assign(currentDocument,{ title, description, categories:[category], tags:selectedEditTags, actions, content });
      isEditMode=false; renderDocumentCard(); loadDocuments();
    }
    function toggleActions(){
      const list=document.getElementById('docActionsList'); const btn=event.target;
      if(list.classList.contains('collapsed')){ list.classList.remove('collapsed'); btn.textContent='–°–≤–µ—Ä–Ω—É—Ç—å'; }
      else { list.classList.add('collapsed'); btn.textContent='–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ ('+(currentDocument.actions?.length||0)+')'; }
    }
    async function deleteDocument(id){
      if(!confirm('–£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç?')) return;
      const doc = allDocuments.find(d=>d.id===id); if(!doc) return;
      const fileName = doc.file_url.split('/').pop();
      await supabase.storage.from('documents').remove([fileName]);
      const { error } = await supabase.from('documents').delete().eq('id', id);
      if(error){ alert('–û—à–∏–±–∫–∞: '+error.message); return; }
      alert('–î–æ–∫—É–º–µ–Ω—Ç —É–¥–∞–ª–µ–Ω'); closeModal(); loadDocuments();
    }

    // ==== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∞–∫—Å–æ–Ω–æ–º–∏–∏ ====
    function openSettings(type){ renderSettings(type); document.getElementById('settingsOverlay').classList.add('active'); document.body.style.overflow='hidden'; }
    function closeSettings(){ document.getElementById('settingsOverlay').classList.remove('active'); document.body.style.overflow='auto'; }
    function closeSettingsOnOverlay(e){ if(e.target.id==='settingsOverlay') closeSettings(); }

    function renderSettings(type){
      const title = (type==='tags')?'–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞–º–∏':'–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏';
      document.getElementById('settingsTitle').textContent = title;
      const list = (type==='tags')?PREDEFINED_TAGS:PREDEFINED_CATEGORIES;
      let html = '<div class="settings-list">';
      list.forEach(val=>{
        html += `<span class="chip">${val}<button title="–£–¥–∞–ª–∏—Ç—å" onclick="removeItem('${type}','${encodeURIComponent(val)}')">√ó</button></span>`;
      });
      html += '</div>';
      html += `
        <div class="settings-row">
          <input id="settingsInput" type="text" placeholder="–î–æ–±–∞–≤–∏—Ç—å ${type==='tags'?'—Ç–µ–≥':'–∫–∞—Ç–µ–≥–æ—Ä–∏—é'}">
          <button class="btn btn-primary" style="flex:0 0 auto;min-width:120px" onclick="addItem('${type}')">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div class="help-text" style="margin-top:8px">–•—Ä–∞–Ω–∏—Ç—Å—è –≤ Supabase. <a href="#" onclick="resetDefaults();return false;" style="color:#72E4A0;text-decoration:underline;">–°–±—Ä–æ—Å –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</a></div>
      `;
      document.getElementById('settingsContent').innerHTML=html;
    }

    async function addItem(type){
      const input=document.getElementById('settingsInput');
      const val=(input.value||'').trim().toLowerCase();
      if(!val) return;
      if(type==='tags' || type==='categories'){
        const { error } = await supabase.rpc('taxonomy_add', { kind:type, value:val });
        if(error){ alert('–û—à–∏–±–∫–∞: '+error.message); return; }
      }
      await loadTaxonomy();
      populateCategorySelect(); populateCategoryFilter(); populateTagSelector(); populateEditTagSelector(); updateTagSuggestions(); renderSettings(type);
      input.value='';
    }

    async function removeItem(type, encodedVal){
      const val=decodeURIComponent(encodedVal||'').trim().toLowerCase();
      if(!val) return;
      if(type==='tags' || type==='categories'){
        const { error } = await supabase.rpc('taxonomy_remove', { kind:type, value:val });
        if(error){ alert('–û—à–∏–±–∫–∞: '+error.message); return; }
      }
      await loadTaxonomy();
      populateCategorySelect(); populateCategoryFilter(); populateTagSelector(); populateEditTagSelector(); updateTagSuggestions(); renderSettings(type);
    }

    async function resetDefaults(){
      const { error } = await supabase.from('taxonomy').update({ categories: DEFAULT_CATEGORIES, tags: DEFAULT_TAGS }).eq('slug','global');
      if(error){ alert('–û—à–∏–±–∫–∞: '+error.message); return; }
      await loadTaxonomy();
      populateCategorySelect(); populateCategoryFilter(); populateTagSelector(); populateEditTagSelector(); updateTagSuggestions();
      const t=document.getElementById('settingsTitle').textContent; renderSettings(t.includes('—Ç–µ–≥')?'tags':'categories');
    }

    // ==== –†–µ–∞–ª—Ç–∞–π–º ====
    function initRealtime(){
      supabase.channel('taxonomy_changes')
        .on('postgres_changes', { event:'*', schema:'public', table:'taxonomy' }, async ()=>{ await loadTaxonomy(); populateCategorySelect(); populateCategoryFilter(); populateTagSelector(); populateEditTagSelector(); updateTagSuggestions(); applyFilters(); })
        .subscribe();
      supabase.channel('documents_changes')
        .on('postgres_changes', { event:'*', schema:'public', table:'documents' }, async ()=>{ await loadDocuments(); applyFilters(); })
        .subscribe();
    }

    // Esc –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫–∏
    document.addEventListener('keydown', e=>{
      if(e.key==='Escape'){
        const previewModal=document.getElementById('previewModal');
        const mainModal=document.getElementById('modalOverlay');
        const uploadModal=document.getElementById('uploadModal');
        const settingsModal=document.getElementById('settingsOverlay');
        if(previewModal.classList.contains('active')) closePreview();
        else if(mainModal.classList.contains('active')) { if(isEditMode) cancelEdit(); else closeModal(); }
        else if(uploadModal.classList.contains('active')) closeUploadModal();
        else if(settingsModal.classList.contains('active')) closeSettings();
      }
    });

    // –°—Ç–∞—Ä—Ç
    initializeApp();
  </script>
</body>
</html>
