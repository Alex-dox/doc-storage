 <!DOCTYPE html>
 <html lang="ru">
 <head>
   <meta charset="UTF-8" />
   <title>DocStorage</title>
   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
 
   <!-- Supabase SDK (UMD) -->
   <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
   <script>
     // –¢–í–û–ô –ø—Ä–æ–µ–∫—Ç Supabase
     const SUPABASE_URL = 'https://zudvtnxzwnyxxtgmlenf.supabase.co';
     const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp1ZHZ0bnh6d255eHh0Z21sZW5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5MTIzNTAsImV4cCI6MjA3NjQ4ODM1MH0.ZJGsAv6H-rm6NzUrT_jWITvwZbrRDsxLcDSNOIfQzgk';
 
     // –ï–¥–∏–Ω—ã–π –∫–ª–∏–µ–Ω—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–ª–µ–µ –∫–∞–∫ `supabase`)
     const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
 
     // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ä–∞–Ω–Ω–∏—Ö –æ—à–∏–±–æ–∫
     window.addEventListener('error', e => console.error('Runtime error:', e.error || e.message));
     window.addEventListener('unhandledrejection', e => console.error('Unhandled:', e.reason));
   </script>
 
   <style>
     * { box-sizing: border-box; }
    body { font-family:'Inter',-apple-system,sans-serif; background:#181A1B; color:#F3F6F8; margin:0; display:flex; min-height:100vh; }
    aside { width:280px; background:#202225; display:flex; flex-direction:column; padding:24px 16px; border-right:1px solid #2a2d2f; overflow-y:auto; }
     .menu-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;}
     .menu-logo{font-weight:600;font-size:20px;color:#72E4A0;}
     .add-icon-btn{width:32px;height:32px;background:#72E4A0;color:#181A1B;border:none;border-radius:6px;font-size:20px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s;line-height:1;}
     .add-icon-btn:hover{background:#4BC483;transform:scale(1.05);}
     .section-header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px;}
     .gear-btn{width:26px;height:26px;border:none;border-radius:6px;background:#2a2d2f;color:#B6BABF;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;font-size:14px;transition:.2s;}
     .gear-btn:hover{background:#3a3d3f;color:#F3F6F8;}
     .search-section{margin-bottom:20px;}
     .search-label{font-size:11px;color:#74cba4;font-weight:600;text-transform:uppercase;}
     .and-toggle{display:flex;align-items:center;gap:8px;font-size:12px;color:#B6BABF;user-select:none;}
     .search-input{width:100%;background:#2a2d2f;border:1px solid #3a3d3f;border-radius:8px;padding:10px 12px;color:#F3F6F8;font-size:14px;margin-bottom:10px;}
     .search-input:focus{outline:none;border-color:#72E4A0;}
     .search-tags-container{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;}
     .search-tag{padding:4px 8px;border-radius:6px;font-size:12px;display:flex;align-items:center;gap:4px;cursor:pointer;}
     .search-tag-remove{font-weight:bold;opacity:.7;}
     .search-tag-remove:hover{opacity:1;}
     .tag-suggestions{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px;}
     .tag-suggestion{padding:3px 8px;border-radius:6px;font-size:11px;cursor:pointer;transition:opacity .2s;}
     .tag-suggestion:hover{opacity:.8;}
     .menu-section{margin-bottom:24px;}
     .menu-section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
     .menu-title{font-size:12px;text-transform:uppercase;color:#74cba4;font-weight:600;}
     .menu-item{padding:8px 12px;border-radius:8px;cursor:pointer;transition:background .2s;font-size:14px;color:#B6BABF;margin-bottom:4px;display:flex;align-items:center;justify-content:space-between;}
     .menu-item:hover{background:#2a2d2f;color:#F3F6F8;}
     .menu-item.active{background:rgba(114,228,160,.15);color:#72E4A0;}
     .item-count{font-size:12px;color:#6a6d6f;background:#2a2d2f;padding:2px 6px;border-radius:4px;}
     main{flex:1;display:flex;flex-direction:column;padding:32px 40px;overflow-y:auto;}
     .main-header{margin-bottom:24px;}
     .main-title{font-size:28px;font-weight:600;margin:0 0 8px 0;}
     .main-subtitle{font-size:15px;color:#B6BABF;}
     .preview-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px;}
     .preview-card{background:#212324;border-radius:12px;padding:20px;cursor:pointer;transition:.2s;border:2px solid transparent;}
     .preview-card:hover{border-color:#72E4A0;transform:translateY(-2px);box-shadow:0 4px 12px rgba(114,228,160,.15);}
     .preview-header{display:flex;gap:12px;margin-bottom:12px;}
    .preview-icon{width:48px;height:48px;background:#2a2d2f;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
     .preview-info{flex:1;min-width:0;}
     .preview-title{font-size:16px;font-weight:600;margin-bottom:4px;color:#F3F6F8;line-height:1.3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
     .preview-category{font-size:12px;color:#74cba4;font-weight:500;}
     .preview-desc{font-size:13px;color:#B6BABF;line-height:1.5;margin-bottom:12px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
     .preview-tags{display:flex;gap:6px;flex-wrap:wrap;}
     .preview-tag{font-size:11px;border-radius:6px;padding:3px 8px;}
     .upload-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(24,26,27,.85);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:1000;padding:40px;overflow-y:auto;}
     .upload-modal.active{display:flex;}
     .upload-form{background:#212324;border-radius:16px;max-width:600px;width:100%;padding:32px 28px;max-height:90vh;overflow-y:auto;}
     .upload-form h2{margin:0 0 24px 0;font-size:22px;color:#F3F6F8;}
     .form-group{margin-bottom:20px;}
     .form-group label{display:block;margin-bottom:8px;color:#74cba4;font-size:14px;font-weight:500;}
     .form-group input[type="text"],.form-group textarea,.form-group select{width:100%;background:#2a2d2f;border:1px solid #3a3d3f;border-radius:8px;padding:10px 12px;color:#F3F6F8;font-size:14px;}
     .form-group textarea{resize:vertical;min-height:80px;}
     .file-input-wrapper{position:relative;background:#2a2d2f;border:2px dashed #72E4A0;border-radius:8px;padding:30px;text-align:center;cursor:pointer;transition:.2s;}
     .file-input-wrapper:hover{background:#323537;border-color:#4BC483;}
     .file-input-wrapper input[type="file"]{position:absolute;opacity:0;width:100%;height:100%;top:0;left:0;cursor:pointer;}
     .file-input-label{color:#B6BABF;font-size:14px;}
     .selected-file{margin-top:12px;color:#72E4A0;font-size:13px;}
     .ai-status{margin-top:12px;padding:10px 12px;border-radius:8px;font-size:13px;display:none;}
     .ai-status.analyzing{display:block;background:rgba(114,228,160,.1);color:#72E4A0;border:1px solid rgba(114,228,160,.3);}
     .ai-status.error{display:block;background:rgba(255,159,64,.1);color:#ff9f40;border:1px solid rgba(255,159,64,.3);}
    .tag-selector{display:flex;flex-wrap:wrap;gap:8px;padding:12px;background:#2a2d2f;border:1px solid #3a3d3f;border-radius:8px;max-height:220px;overflow-y:auto;}
    .tag-option{background:rgba(114,228,160,.1);color:#72E4A0;padding:6px 12px;border-radius:6px;font-size:13px;cursor:pointer;transition:.2s;border:1px solid transparent;display:inline-flex;align-items:center;gap:6px;}
     .tag-option:hover{background:rgba(114,228,160,.2);}
     .tag-option.selected{background:rgba(114,228,160,.25);border-color:#72E4A0;}
    .tag-remove{background:transparent;border:none;color:#b6babf;cursor:pointer;font-size:14px;padding:0 2px;line-height:1;}
    .tag-remove:hover{color:#ff6b6b;}
     .help-text{font-size:12px;color:#6a6d6f;margin-top:4px;}
    .form-buttons{display:flex;gap:12px;margin-top:24px;flex-wrap:wrap;}
    .inline-manage{display:flex;gap:8px;margin-top:10px;align-items:center;flex-wrap:wrap;}
    .inline-manage input{flex:1;min-width:180px;background:#2a2d2f;border:1px solid #3a3d3f;border-radius:8px;padding:8px 10px;color:#F3F6F8;}
    .inline-manage .mini-btn{background:#2a2d2f;border:1px solid #3a3d3f;color:#B6BABF;border-radius:8px;padding:8px 12px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;transition:.2s;}
    .inline-manage .mini-btn:hover{border-color:#72E4A0;color:#72E4A0;}
    .inline-help{font-size:12px;color:#6a6d6f;margin:6px 0 0;}
     .btn{flex:1;padding:12px 24px;border:none;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;transition:.2s;}
     .btn-primary{background:#72E4A0;color:#181A1B;}
     .btn-primary:hover{background:#4BC483;}
     .btn-primary:disabled{background:#3a3d3f;color:#6a6d6f;cursor:not-allowed;}
     .btn-secondary{background:transparent;color:#B6BABF;border:1px solid #3a3d3f;}
     .btn-secondary:hover{background:#2a2d2f;}
     .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(24,26,27,.85);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:1000;padding:40px;}
     .modal-overlay.active{display:flex;}
     .modal-card{background:#212324;border-radius:16px;max-width:700px;width:100%;max-height:90vh;overflow-y:auto;position:relative;padding:32px 28px 28px;animation:modalSlideIn .3s ease;}
     @keyframes modalSlideIn{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
     .close-btn{position:absolute;top:20px;right:20px;width:32px;height:32px;border:none;background:#2a2d2f;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s;color:#B6BABF;font-size:20px;z-index:10;}
     .close-btn:hover{background:#72E4A0;color:#181A1B;}
     .preview-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(24,26,27,.95);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:2000;padding:40px;}
     .preview-modal.active{display:flex;}
     .preview-container{background:#212324;border-radius:16px;max-width:90vw;max-height:90vh;width:100%;height:100%;position:relative;display:flex;flex-direction:column;overflow:hidden;}
     .preview-header{padding:20px 24px;border-bottom:1px solid #2a2d2f;display:flex;align-items:center;justify-content:space-between;}
     .preview-title-text{font-size:18px;font-weight:600;color:#F3F6F8;}
     .preview-content{flex:1;overflow:auto;display:flex;align-items:center;justify-content:center;padding:20px;}
     .preview-content iframe{width:100%;height:100%;border:none;border-radius:8px;}
     .preview-content img{max-width:100%;max-height:100%;object-fit:contain;border-radius:8px;}
     .loading{text-align:center;padding:40px;color:#B6BABF;}
 
     /* –î–æ–∫-–∫–∞—Ä—Ç–∞ */
     .settings-list{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:8px;background:#2a2d2f;color:#DEE6EA;font-size:13px;border:1px solid #2f3234;}
     .chip button{border:none;background:transparent;color:#ff6b6b;font-size:14px;cursor:pointer;padding:0 2px;}
    .chip .chip-icon{color:#9aa0a6;}
    .chip .chip-action{color:#B6BABF;}
 
     .doc-title{font-size:20px;font-weight:600;margin:0 0 8px 0;color:#F3F6F8;}
     .doc-desc{font-size:13px;color:#B6BABF;line-height:1.6;margin-bottom:8px;}
     .doc-section{padding:12px 0;border-top:1px solid #2a2d2f;}
     .doc-section:first-of-type{border-top:none;padding-top:0;}
     .section-label{font-size:11px;text-transform:uppercase;letter-spacing:.04em;color:#74cba4;font-weight:600;margin-bottom:8px;}
     .doc-tags{display:flex;flex-wrap:wrap;gap:6px;}
     .doc-tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:8px;font-size:12px;background:#2a2d2f;color:#DEE6EA;border:1px solid #3a3d3f;}
     .doc-actions-list{margin:0;padding-left:18px;}
     .doc-actions-list.collapsed li:nth-child(n+6){display:none;}
     .show-more-actions{margin-top:8px;background:#2a2d2f;border:1px solid #3a3d3f;color:#B6BABF;border-radius:8px;padding:8px 10px;cursor:pointer;}
     .show-more-actions:hover{background:#303335;color:#F3F6F8;}
     .doc-actions-bar{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;}
     .icon-btn{width:36px;height:36px;border-radius:8px;border:1px solid #3a3d3f;background:#2a2d2f;color:#B6BABF;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;transition:.2s;}
     .icon-btn:hover{background:#303335;color:#F3F6F8;}
     .icon-btn.delete:hover{border-color:#ff6b6b;color:#ff6b6b;}
     .icon{width:18px;height:18px;display:block;}
    .icon-dark{fill:none;stroke:#B6BABF;stroke-width:1.6;stroke-linecap:round;stroke-linejoin:round;}
    .category-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:8px;background:#2a2d2f;border:1px solid #3a3d3f;color:#DEE6EA;}
    .category-icon{width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;}
    .icon-only-btn{background:#2a2d2f;border:1px solid #3a3d3f;color:#B6BABF;border-radius:8px;padding:8px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;transition:.2s;}
    .icon-only-btn:hover{border-color:#72E4A0;color:#72E4A0;}

    @media (max-width: 960px){
      body{flex-direction:column;}
      aside{width:100%;border-right:none;border-bottom:1px solid #2a2d2f;position:sticky;top:0;z-index:900;max-height:80vh;}
      main{padding:20px;}
      .menu-section{margin-bottom:16px;}
      .preview-grid{display:flex;flex-direction:column;gap:14px;}
      .preview-card{width:100%;}
      .menu-header{position:sticky;top:0;background:#202225;padding-bottom:12px;z-index:910;}
    }
   </style>
 </head>
 <body>
   <aside>
     <div class="menu-header">
       <div class="menu-logo">DocStorage</div>
      <button class="add-icon-btn" onclick="openUploadModal()" title="–î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç">
        <svg class="icon" viewBox="0 0 24 24"><path class="icon-dark" d="M12 5v14M5 12h14"/></svg>
      </button>
     </div>
 
     <div class="search-section">
       <div class="search-label">–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É</div>
       <input type="text" class="search-input" id="textSearch" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ..." />
     </div>
 
     <div class="search-section">
       <div class="section-header">
         <div class="search-label">–¢–µ–≥–∏</div>
         <button class="gear-btn" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞–º–∏" onclick="openSettings('tags')">
           <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 8.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7Z" stroke="currentColor" stroke-width="1.6"/><path d="M4 12c0-.5.05-1 .15-1.47l-1.9-1.1 2-3.46 1.9 1.1c.7-.56 1.5-1 2.36-1.3V3h4v2.77c.86.3 1.66.74 2.36 1.3l1.9-1.1 2 3.46-1.9 1.1c.1.47.15.97.15 1.47s-.05 1-.15 1.47l1.9 1.1-2 3.46-1.9-1.1c-.7.56-1.5 1-2.36 1.3V21h-4v-2.77c-.86-.3-1.66-.74-2.36-1.3l-1.9 1.1-2-3.46 1.9-1.1c-.1-.47-.15-.97-.15-1.47Z" stroke="currentColor" stroke-width="1.6"/></svg>
         </button>
       </div>
       <div class="search-tags-container" id="selectedSearchTags"></div>
       <div class="tag-suggestions" id="tagSuggestions"></div>
       <label class="and-toggle"><input type="checkbox" id="tagsAndMode" /> –í—Å–µ —Ç–µ–≥–∏</label>
     </div>
 
    <div class="search-section">
      <div class="section-header">
        <div class="search-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
        <button class="gear-btn" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏" onclick="openSettings('categories')">
          <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 8.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7Z" stroke="currentColor" stroke-width="1.6"/><path d="M4 12c0-.5.05-1 .15-1.47l-1.9-1.1 2-3.46 1.9 1.1c.7-.56 1.5-1 2.36-1.3V3h4v2.77c.86.3 1.66.74 2.36 1.3l1.9-1.1 2 3.46-1.9 1.1c.1.47.15.97.15 1.47s-.05 1-.15 1.47l1.9 1.1-2 3.46-1.9-1.1c-.7.56-1.5 1-2.36 1.3V21h-4v-2.77c-.86-.3-1.66-.74-2.36-1.3l-1.9 1.1-2-3.46 1.9-1.1c-.1-.47-.15-.97-.15-1.47Z" stroke="currentColor" stroke-width="1.6"/></svg>
        </button>
      </div>
      <select class="search-input" id="categoryFilter">
        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
      </select>
    </div>

    <div class="menu-section">
      <div class="menu-section-header">
        <div class="menu-title">–¢–µ–≥–∏ (–≤—Å–µ)</div>
        <button class="gear-btn" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞–º–∏" onclick="openSettings('tags')">‚öôÔ∏è</button>
      </div>
      <div id="tagsList"></div>
    </div>

    <div class="menu-section">
      <div class="menu-section-header">
        <div class="menu-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
        <button class="gear-btn" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏" onclick="openSettings('categories')">‚öôÔ∏è</button>
      </div>
      <div id="categoriesList"></div>
    </div>
  </aside>
 
   <main>
     <div class="main-header">
       <h1 class="main-title" id="mainTitle">–í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</h1>
       <p class="main-subtitle">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π</p>
     </div>
     <div class="preview-grid" id="previewGrid">
       <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤...</div>
     </div>
   </main>
 
   <!-- Upload -->
   <div class="upload-modal" id="uploadModal">
     <div class="upload-form">
      <h2 id="uploadTitle">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</h2>
       <form id="uploadForm">
         <div class="form-group">
           <label>–§–∞–π–ª *</label>
           <div class="file-input-wrapper">
             <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png" required />
             <div class="file-input-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª (PDF, JPEG, PNG)</div>
             <div class="selected-file" id="selectedFile"></div>
             <div class="ai-status" id="aiStatus"></div>
            <div class="help-text" id="existingFileHint"></div>
           </div>
         </div>
 
         <div class="form-group">
           <label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
           <input type="text" id="titleInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞" required />
         </div>
 
         <div class="form-group">
           <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
           <textarea id="descInput" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞"></textarea>
         </div>
 
         <div class="form-group">
           <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
          <div class="inline-manage">
            <select id="categorySelect" required>
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
            </select>
            <button type="button" class="mini-btn" onclick="openCategoryIconPrompt()">
              <svg class="icon" viewBox="0 0 24 24"><path class="icon-dark" d="M12 4v4m0 0H8m4-4h4m0 8v4m0-4h4m-4 4h-4M4 12h4m0 0V8m0 4v4m4-4h4"/></svg>
              –ò–∫–æ–Ω–∫–∞
            </button>
          </div>
          <div class="inline-manage">
            <input id="newCategoryInput" type="text" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é" />
            <button type="button" class="mini-btn" onclick="addInlineCategory()">
              <svg class="icon" viewBox="0 0 24 24"><path class="icon-dark" d="M12 5v14m-7-7h14"/></svg>
              –î–æ–±–∞–≤–∏—Ç—å
            </button>
          </div>
          <div class="settings-list" id="categoryChips"></div>
          <div class="inline-help">–ö–ª–∏–∫ –ø–æ –∫—Ä–µ—Å—Ç—É —É–¥–∞–ª–∏—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ —Å–ø–∏—Å–∫–∞. –î–ª—è –Ω–æ–≤—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞–≤–∏—Ç—Å—è –∏–∫–æ–Ω–∫–∞ üíæ.</div>
         </div>
 
         <div class="form-group">
           <label>–¢–µ–≥–∏</label>
           <div class="tag-selector" id="tagSelector"></div>
          <div class="inline-manage">
            <input id="newTagInput" type="text" placeholder="–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥" />
            <button type="button" class="mini-btn" onclick="addInlineTag()">
              <svg class="icon" viewBox="0 0 24 24"><path class="icon-dark" d="M12 5v14m-7-7h14"/></svg>
              –î–æ–±–∞–≤–∏—Ç—å
            </button>
          </div>
          <div class="inline-help">–¢–∞–ø –ø–æ —Ç–µ–≥—É –≤—ã–±–∏—Ä–∞–µ—Ç –µ–≥–æ, –∫—Ä–µ—Å—Ç–∏–∫ —É–¥–∞–ª—è–µ—Ç –∏–∑ —Å–ø–∏—Å–∫–∞.</div>
         </div>
 
         <div class="form-group">
           <label>–î–µ–π—Å—Ç–≤–∏—è (–≤–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –∫–æ–¥—ã, –¥–∞—Ç—ã, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å)</label>
           <textarea id="actionsInput" placeholder="–ö–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä:&#10;–ö–æ–¥: 123456&#10;–°—Ä–æ–∫: 1 –Ω–æ—è–±—Ä—è 2025&#10;–û–ø–ª–∞—Ç–∏—Ç—å —Å—á–µ—Ç"></textarea>
         </div>
 
         <div class="form-group">
           <label>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</label>
           <textarea id="contentInput" placeholder="–û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞" style="min-height:120px;"></textarea>
         </div>
 
         <div class="form-buttons">
           <button type="button" class="btn btn-secondary" onclick="closeUploadModal()">–û—Ç–º–µ–Ω–∞</button>
           <button type="submit" class="btn btn-primary" id="uploadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
         </div>
       </form>
     </div>
   </div>
 
   <!-- –î–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∞ -->
   <div class="modal-overlay" id="modalOverlay" onclick="closeModalOnOverlay(event)">
     <div class="modal-card" onclick="event.stopPropagation()">
       <button class="close-btn" onclick="closeModal()">√ó</button>
       <div id="modalContent"></div>
   <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
   <div class="modal-overlay" id="settingsOverlay" onclick="closeSettingsOnOverlay(event)">
     <div class="modal-card" onclick="event.stopPropagation()">
       <button class="close-btn" onclick="closeSettings()">√ó</button>
       <h2 id="settingsTitle" style="margin-top:0;color:#F3F6F8;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
       <div id="settingsContent"></div>
     </div>
   </div>
 
   <!-- –ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–∞ -->
   <div class="preview-modal" id="previewModal" onclick="closePreview(event)">
     <div class="preview-container" onclick="event.stopPropagation()">
       <div class="preview-header">
         <div class="preview-title-text" id="previewTitle">–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞</div>
         <button class="close-btn" onclick="closePreview()">√ó</button>
       </div>
       <div class="preview-content" id="previewContent">
         <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
       </div>
     </div>
   </div>
 
   <script>
     // ==== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ====
     const DEFAULT_CATEGORIES = ['–ñ–∏–ª—å–µ','–§–∏–Ω–∞–Ω—Å—ã','–†–∞–±–æ—Ç–∞','–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è','–ú–µ–¥–∏—Ü–∏–Ω–∞'];
    const DEFAULT_CATEGORY_ICONS = {
      '–ñ–∏–ª—å–µ':'üîë',
      '–§–∏–Ω–∞–Ω—Å—ã':'üí∂',
      '–†–∞–±–æ—Ç–∞':'üíª',
      '–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è':'üí≥',
      '–ú–µ–¥–∏—Ü–∏–Ω–∞':'üíä'
    };
     const DEFAULT_TAGS = ['CAF','CADA','OFPRA','ANEF','France Travail','Credit Mutuel'];
    const TAG_COLOR_PALETTE = ['#72E4A0','#7FD7FF','#FFB870','#C792EA','#E57373','#64B5F6','#FFD54F','#4DD0E1','#A3E635','#F48FB1','#CE93D8','#9FA8DA'];
    const ICONS = {
      file:`<svg class="icon" viewBox="0 0 24 24"><path class="icon-dark" d="M7 4h6.6L17 7.4V20a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1Z"/><path class="icon-dark" d="M13.5 4V8h4"/></svg>`,
      view:`<svg class="icon" viewBox="0 0 24 24"><path class="icon-dark" d="M3 12s3.5-5 9-5 9 5 9 5-3.5 5-9 5-9-5-9-5Z"/><circle class="icon-dark" cx="12" cy="12" r="2.5"/></svg>`,
      edit:`<svg class="icon" viewBox="0 0 24 24"><path class="icon-dark" d="m5 19 3.4-.6 9-9a1.2 1.2 0 0 0 0-1.8l-1-1a1.2 1.2 0 0 0-1.8 0l-9 9L5 19Z"/><path class="icon-dark" d="M14 6.5 17.5 10"/></svg>`,
      download:`<svg class="icon" viewBox="0 0 24 24"><path class="icon-dark" d="M12 4v10"/><path class="icon-dark" d="m8 10 4 4 4-4"/><path class="icon-dark" d="M5 19h14"/></svg>`,
      trash:`<svg class="icon" viewBox="0 0 24 24"><path class="icon-dark" d="M5 7h14"/><path class="icon-dark" d="M10 10v6"/><path class="icon-dark" d="M14 10v6"/><path class="icon-dark" d="M6 7 7 19a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1l1-12"/><path class="icon-dark" d="M9 7V5a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>`,
      tag:`<svg class="icon" viewBox="0 0 24 24"><path class="icon-dark" d="M7 5h6l5 5-7 7-5-5V5Z"/><circle class="icon-dark" cx="10" cy="10" r="1.3"/></svg>`,
      link:`<svg class="icon" viewBox="0 0 24 24"><path class="icon-dark" d="M10 14 8.5 15.5a3.5 3.5 0 0 1-5-5L6 8"/><path class="icon-dark" d="M14 10 15.5 8.5a3.5 3.5 0 0 1 5 5L18 16"/><path class="icon-dark" d="M9 12.5 12.5 9"/></svg>`,
      gear:`<svg class="icon" viewBox="0 0 24 24"><path class="icon-dark" d="M12 8.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7Z"/><path class="icon-dark" d="M4 12c0-.5.05-1 .15-1.47l-1.9-1.1 2-3.46 1.9 1.1c.7-.56 1.5-1 2.36-1.3V3h4v2.77c.86.3 1.66.74 2.36 1.3l1.9-1.1 2 3.46-1.9 1.1c.1.47.15.97.15 1.47s-.05 1-.15 1.47l1.9 1.1-2 3.46-1.9-1.1c-.7.56-1.5 1-2.36 1.3V21h-4v-2.77c-.86-.3-1.66-.74-2.36-1.3l-1.9 1.1-2-3.46 1.9-1.1c-.1-.47-.15-.97-.15-1.47Z"/></svg>`,
      plus:`<svg class="icon" viewBox="0 0 24 24"><path class="icon-dark" d="M12 5v14M5 12h14"/></svg>`
     };
 
     // ==== –°–æ—Å—Ç–æ—è–Ω–∏–µ ====
     let PREDEFINED_CATEGORIES = [];
     let PREDEFINED_TAGS = [];
    let CATEGORY_ICONS = {};
    let tagColorMap = {};
     let allDocuments = [];
     let currentDocument = null;
     let selectedTags = [];
     let selectedSearchTags = [];
     let formMode = 'create';
     let editingDocument = null;
 
     // ==== –£—Ç–∏–ª–∏—Ç—ã ====
    function hexToRgba(hex, alpha){
      const clean = hex.replace('#','');
      const bigint = parseInt(clean, 16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      return `rgba(${r},${g},${b},${alpha})`;
    }
    function ensureTagColor(tag){
      if(tagColorMap[tag]) return tagColorMap[tag];
      const index = Object.keys(tagColorMap).length;
      const paletteColor = TAG_COLOR_PALETTE[index % TAG_COLOR_PALETTE.length];
      const hueBase = (index * 37) % 360;
      const bg = paletteColor ? hexToRgba(paletteColor, 0.22) : `hsla(${hueBase},60%,28%,0.22)`;
      const text = paletteColor || `hsl(${hueBase},70%,70%)`;
      tagColorMap[tag] = { bg, text };
      return tagColorMap[tag];
    }
    function getTagStyle(tag){ const c=ensureTagColor(tag); return `background:${c.bg}; color:${c.text};`; }
    function getAllKnownTags(){
      const set=new Set();
      PREDEFINED_TAGS.forEach(t=>set.add(t));
      allDocuments.forEach(d=>(d.tags||[]).forEach(t=>set.add(t)));
      return Array.from(set).sort((a,b)=>a.localeCompare(b,'ru'));
    }
    function persistCategoryIcons(){ try{ localStorage.setItem('categoryIcons', JSON.stringify(CATEGORY_ICONS)); }catch(e){ console.warn('Icon save',e); } }
    function loadCategoryIcons(){
      try{ const saved = JSON.parse(localStorage.getItem('categoryIcons')||'{}'); CATEGORY_ICONS = saved || {}; }
      catch(e){ CATEGORY_ICONS={}; }
    }
    function syncCategoryIcons(){
      PREDEFINED_CATEGORIES.forEach(cat=>{ if(!CATEGORY_ICONS[cat]) CATEGORY_ICONS[cat]=DEFAULT_CATEGORY_ICONS[cat]||'üíæ'; });
      Object.keys(CATEGORY_ICONS).forEach(cat=>{ if(!PREDEFINED_CATEGORIES.includes(cat)) delete CATEGORY_ICONS[cat]; });
      persistCategoryIcons();
    }
    function getCategoryIcon(cat){ return CATEGORY_ICONS[cat] || 'üíæ'; }
 
     // ==== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ====
     async function loadTaxonomy(){
       try{
         const { data, error } = await supabase
           .from('taxonomy').select('categories,tags')
           .eq('slug','global')
           .single();
         if(error) throw error;
         PREDEFINED_CATEGORIES = Array.isArray(data?.categories) && data.categories.length ? data.categories.slice() : DEFAULT_CATEGORIES.slice();
         PREDEFINED_TAGS = Array.isArray(data?.tags) && data.tags.length ? data.tags.slice() : DEFAULT_TAGS.slice();
       }catch(e){
         console.warn('loadTaxonomy fallback:', e?.message || e);
         PREDEFINED_CATEGORIES = DEFAULT_CATEGORIES.slice();
         PREDEFINED_TAGS = DEFAULT_TAGS.slice();
       }
      loadCategoryIcons();
      syncCategoryIcons();
      PREDEFINED_TAGS.forEach(ensureTagColor);
     }
 
     async function loadDocuments(){
       try{
         const { data, error } = await supabase
           .from('documents')
           .select('*')
           .order('created_at',{ascending:false});
         if(error) throw error;
        allDocuments = data || [];
        allDocuments.forEach(d=> (d.tags||[]).forEach(ensureTagColor));
        populateTagSelector();
        updateFilters();
        updateTagSuggestions();
        applyFilters();
      }catch(e){
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
        document.getElementById('previewGrid').innerHTML = '<div class="loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
      }
    }
 
     async function initializeApp(){
       await loadTaxonomy();
       populateCategorySelect();
       populateCategoryFilter();
       populateTagSelector();
      renderCategoryChips();
       updateTagSuggestions();
       await loadDocuments();
 
       document.getElementById('textSearch').addEventListener('input', applyFilters);
       document.getElementById('categoryFilter').addEventListener('change', applyFilters);
       document.getElementById('tagsAndMode').addEventListener('change', applyFilters);
 
       initRealtime();
     }
 
     // ==== UI –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ ====
     function populateCategorySelect(){
       const select = document.getElementById('categorySelect');
       select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
       PREDEFINED_CATEGORIES.forEach(c=>{
         const o=document.createElement('option'); o.value=c; o.textContent=c; select.appendChild(o);
       });
      renderCategoryChips();
     }
     function populateCategoryFilter(){
       const select = document.getElementById('categoryFilter');
       const current = select.value || '';
       select.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';
       PREDEFINED_CATEGORIES.forEach(c=>{
         const o=document.createElement('option'); o.value=c; o.textContent=c; select.appendChild(o);
       });
       if(current && PREDEFINED_CATEGORIES.includes(current)) select.value=current;
     }
    function renderCategoryChips(){
      const wrap = document.getElementById('categoryChips');
      if(!wrap) return;
      wrap.innerHTML='';
      PREDEFINED_CATEGORIES.forEach(cat=>{
        const chip=document.createElement('span');
        chip.className='chip';
        chip.innerHTML=`<span class="chip-icon">${getCategoryIcon(cat)}</span><span>${cat}</span><button class="chip-action" title="–ò–∫–æ–Ω–∫–∞" onclick="event.stopPropagation();promptCategoryIcon('${encodeURIComponent(cat)}')">${ICONS.gear}</button><button title="–£–¥–∞–ª–∏—Ç—å" onclick="event.stopPropagation();removeItem('categories','${encodeURIComponent(cat)}')">√ó</button>`;
        wrap.appendChild(chip);
      });
    }
    function populateTagSelector(){
      const wrap = document.getElementById('tagSelector');
      wrap.innerHTML = '';
      getAllKnownTags().forEach(t=>{
        const el = document.createElement('div');
       el.className='tag-option';
       el.dataset.tag=t;
       ensureTagColor(t);
        el.style.cssText=getTagStyle(t);
        el.innerHTML = `<span>${t}</span><button class="tag-remove" title="–£–¥–∞–ª–∏—Ç—å" onclick="event.stopPropagation();removeInlineTag('${encodeURIComponent(t)}')">√ó</button>`;
         el.onclick=()=>toggleTag(t);
         wrap.appendChild(el);
       });
       updateTagSelector();
     }
     function toggleTag(t){ const i=selectedTags.indexOf(t); if(i>-1) selectedTags.splice(i,1); else selectedTags.push(t); updateTagSelector(); }
     function updateTagSelector(){
       document.querySelectorAll('#tagSelector .tag-option').forEach(el=>{
        const t=el.dataset.tag; el.classList.toggle('selected', selectedTags.includes(t));
       });
     }
    async function addInlineTag(){
      const input=document.getElementById('newTagInput');
      const val=(input.value||'').trim();
      if(!val) return;
      await addItem('tags', val);
      input.value='';
      toggleTag(val);
    }
    function removeInlineTag(encoded){
      removeItem('tags', encoded);
    }
    async function addInlineCategory(){
      const input=document.getElementById('newCategoryInput');
      const val=(input.value||'').trim();
      if(!val) return;
      await addItem('categories', val);
      input.value='';
      document.getElementById('categorySelect').value=val;
    }
 
     // ==== –ü–æ–∏—Å–∫/—Ñ–∏–ª—å—Ç—Ä—ã ====
     function addSearchTag(tag){ if(!selectedSearchTags.includes(tag)){ selectedSearchTags.push(tag); renderSearchTags(); updateTagSuggestions(); applyFilters(); } }
     function removeSearchTag(tag){ const i=selectedSearchTags.indexOf(tag); if(i>-1){ selectedSearchTags.splice(i,1); renderSearchTags(); updateTagSuggestions(); applyFilters(); } }
     function renderSearchTags(){
       const c=document.getElementById('selectedSearchTags'); c.innerHTML='';
       selectedSearchTags.forEach(tag=>{
         const el=document.createElement('div'); el.className='search-tag'; el.style.cssText=getTagStyle(tag);
         el.innerHTML = `${tag} <span class="search-tag-remove" onclick="removeSearchTag('${tag}')">√ó</span>`;
         c.appendChild(el);
       });
     }
      function updateTagSuggestions(){
        const all=getAllKnownTags().filter(t=>!selectedSearchTags.includes(t));
        const c=document.getElementById('tagSuggestions'); c.innerHTML='';
        all.slice(0,6).forEach(t=>{
          const el=document.createElement('div'); el.className='tag-suggestion'; el.textContent=t; el.style.cssText=getTagStyle(t); el.onclick=()=>addSearchTag(t); c.appendChild(el);
        });
      }
     function applyFilters(){
       const q=(document.getElementById('textSearch').value||'').toLowerCase();
       const cat=document.getElementById('categoryFilter').value;
       const andMode=document.getElementById('tagsAndMode').checked;
 
       const filtered = allDocuments.filter(doc=>{
         const textMatch=!q || (doc.title&&doc.title.toLowerCase().includes(q)) || (doc.description&&doc.description.toLowerCase().includes(q));
         const catMatch=!cat || ((doc.categories||[]).includes(cat));
         let tagsMatch=true;
         if(selectedSearchTags.length){
           const tags=doc.tags||[];
           tagsMatch = andMode ? selectedSearchTags.every(t=>tags.includes(t)) : selectedSearchTags.some(t=>tags.includes(t));
         }
         return textMatch && catMatch && tagsMatch;
       });
 
       renderDocuments(filtered);
     }
     function renderDocuments(list){
       const grid=document.getElementById('previewGrid');
       if(!list.length){ grid.innerHTML='<div class="loading">–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</div>'; return; }
       grid.innerHTML = list.map(doc=>{
         const tags=(doc.tags||[]).slice(0,3).map(t=>`<span class="preview-tag" style="${getTagStyle(t)}">${t}</span>`).join('') +
                       ((doc.tags||[]).length>3?`<span class="preview-tag" style="background: rgba(114,228,160,.2); color:#72E4A0;">+${(doc.tags.length-3)}</span>`:'');
         const cat=(doc.categories&&doc.categories[0])||'';
        const catIcon=getCategoryIcon(cat);
         return `
           <div class="preview-card" onclick="openDocumentModal('${doc.id}')">
             <div class="preview-header">
              <div class="preview-icon">${ICONS.file}</div>
               <div class="preview-info">
                 <div class="preview-title">${doc.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                <div class="preview-category"><span class="category-icon">${catIcon}</span>${cat}</div>
               </div>
             </div>
             <div class="preview-desc">${doc.description||'–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
             <div class="preview-tags">${tags}</div>
           </div>`;
       }).join('');
     }
     function updateFilters(){
      const catList=document.getElementById('categoriesList');
      const tagList=document.getElementById('tagsList');
      if(catList){
        const counts={};
        allDocuments.forEach(d=>(d.categories||[]).forEach(c=>counts[c]=(counts[c]||0)+1));
        let html=`<div class="menu-item active" onclick="clearFilters()">–í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã<span class="item-count">${allDocuments.length}</span></div>`;
        PREDEFINED_CATEGORIES.forEach(c=>{ html+=`<div class="menu-item" onclick="quickFilterCategory('${c}')">${c}<span class="item-count">${counts[c]||0}</span></div>`; });
        catList.innerHTML=html;
      }
      if(tagList){
        const tagCounts={};
        allDocuments.forEach(d=>(d.tags||[]).forEach(t=>tagCounts[t]=(tagCounts[t]||0)+1));
        const tags=getAllKnownTags().filter(t=>tagCounts[t]>0);
        if(tags.length){
          tagList.innerHTML=tags.map(t=>`<div class="menu-item" onclick="quickFilterTag('${encodeURIComponent(t)}')" style="${getTagStyle(t)}">${t}<span class="item-count">${tagCounts[t]||0}</span></div>`).join('');
        }else{
          tagList.innerHTML='<div class="menu-item">–ù–µ—Ç —Ç–µ–≥–æ–≤</div>';
        }
      }
    }
    function clearFilters(){ document.getElementById('textSearch').value=''; document.getElementById('categoryFilter').value=''; document.getElementById('tagsAndMode').checked=false; selectedSearchTags=[]; renderSearchTags(); updateTagSuggestions(); applyFilters(); }
    function quickFilterCategory(c){ document.getElementById('categoryFilter').value=c; applyFilters(); }
    function quickFilterTag(encoded){
      const tag=decodeURIComponent(encoded||'');
      selectedSearchTags = tag ? [tag] : [];
      renderSearchTags();
      updateTagSuggestions();
      applyFilters();
    }
 
     // ==== –ú–æ–¥–∞–ª–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ ====
    function openUploadModal(doc=null){
      formMode = doc ? 'edit' : 'create';
      editingDocument = doc;
      const uploadModal=document.getElementById('uploadModal');
      const fileInput=document.getElementById('fileInput');
      const hint=document.getElementById('existingFileHint');
      document.getElementById('uploadTitle').textContent = doc ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç' : '–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç';
      document.getElementById('uploadBtn').textContent = doc ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–ó–∞–≥—Ä—É–∑–∏—Ç—å';
      document.getElementById('aiStatus').style.display='none';
      document.getElementById('selectedFile').textContent='';
      fileInput.value='';
      fileInput.required = !doc;
      if(doc){
        document.getElementById('titleInput').value = doc.title||'';
        document.getElementById('descInput').value = doc.description||'';
        document.getElementById('categorySelect').value = (doc.categories||[])[0]||'';
        document.getElementById('actionsInput').value = (doc.actions||[]).join('\n');
        document.getElementById('contentInput').value = doc.content||'';
        selectedTags = (doc.tags||[]).slice();
        hint.textContent = doc.filename ? `–¢–µ–∫—É—â–∏–π —Ñ–∞–π–ª: ${doc.filename}` : '';
      }else{
        document.getElementById('uploadForm').reset();
        selectedTags=[];
        hint.textContent='';
      }
      updateTagSelector();
      uploadModal.classList.add('active');
      document.body.style.overflow='hidden';
    }
    function closeUploadModal(){
      document.getElementById('uploadModal').classList.remove('active');
      document.getElementById('uploadForm').reset();
      document.getElementById('selectedFile').textContent='';
      document.getElementById('aiStatus').style.display='none';
      document.getElementById('existingFileHint').textContent='';
      selectedTags=[]; editingDocument=null; formMode='create';
      updateTagSelector();
      document.body.style.overflow='auto';
    }
 
     // ==== AI –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ ====
     const GEMINI_API_KEY = 'AIzaSyBqGYEAw2ZMr-n-GG2EoyEZlkRyMtQl8bs';
     async function analyzeDocumentWithGemini(file){
       const aiStatus=document.getElementById('aiStatus');
       aiStatus.className='ai-status analyzing'; aiStatus.textContent='ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –¥–æ–∫—É–º–µ–Ω—Ç...';
       try{
         const base64 = await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result.split(',')[1]); r.onerror=rej; r.readAsDataURL(file); });
         const prompt = '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –∏ –≤–µ—Ä–Ω–∏ JSON —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–æ–ª—è–º–∏:\n- title...\n- description...\n- category –∏–∑: '+PREDEFINED_CATEGORIES.join(', ')+'\n- tags –∏–∑: '+PREDEFINED_TAGS.join(', ')+'\n- actions[]\n- content\n–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.';
         const resp = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key='+GEMINI_API_KEY, {
           method:'POST', headers:{'Content-Type':'application/json'},
           body:JSON.stringify({ contents:[{ parts:[{text:prompt},{ inline_data:{ mime_type:file.type, data:base64 } }]}] })
         });
         if(!resp.ok) throw new Error('API Error');
         const data = await resp.json();
         const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
         const json = JSON.parse((text.match(/\{[\s\S]*\}/)||['{}'])[0]);
         document.getElementById('titleInput').value = json.title || '';
         document.getElementById('descInput').value = json.description || '';
         document.getElementById('categorySelect').value = json.category || '';
         document.getElementById('actionsInput').value = (json.actions||[]).join('\n');
         document.getElementById('contentInput').value = json.content || '';
         selectedTags = (json.tags||[]).filter(t=>PREDEFINED_TAGS.includes(t));
         updateTagSelector();
         aiStatus.style.display='none';
       }catch(e){
         console.error('AI Error:', e);
         aiStatus.className='ai-status error'; aiStatus.textContent='‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Ä—É—á–Ω—É—é';
       }
     }
 
     // ==== –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤/—Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ====
     document.getElementById('fileInput').addEventListener('change', e=>{
       const file=e.target.files[0];
       if(file){
         document.getElementById('selectedFile').textContent='–í—ã–±—Ä–∞–Ω: '+file.name;
         document.getElementById('titleInput').value=file.name.replace(/\.[^/.]+$/,'');
         analyzeDocumentWithGemini(file);
       }
     });
 
      document.getElementById('uploadForm').addEventListener('submit', async e=>{
        e.preventDefault();
        const file = document.getElementById('fileInput').files[0];
        const title = document.getElementById('titleInput').value;
        const description = document.getElementById('descInput').value;
        const category = document.getElementById('categorySelect').value;
        const actionsText = document.getElementById('actionsInput').value;
        const contentText = document.getElementById('contentInput').value;
        if(!category){ alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é'); return; }

        const actions = actionsText ? actionsText.split('\n').map(s=>s.trim()).filter(Boolean) : [];
        const btn = document.getElementById('uploadBtn'); btn.disabled=true; btn.textContent=formMode==='edit'?'–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...':'–ó–∞–≥—Ä—É–∑–∫–∞...';
        try{
          if(formMode==='create'){
            if(!file) { alert('–î–æ–±–∞–≤—å—Ç–µ —Ñ–∞–π–ª'); return; }
            const fileName = Date.now()+'_'+file.name;
            const up = await supabase.storage.from('documents').upload(fileName, file);
            if(up.error) throw up.error;
            const { data:pub } = supabase.storage.from('documents').getPublicUrl(fileName);
            const ins = await supabase.from('documents').insert([{
              filename:file.name, file_url:pub.publicUrl, title, description,
              categories:[category], tags:selectedTags, actions, content:contentText, lang:'ru', ai_filled:true
            }]).select();
            if(ins.error) throw ins.error;
            alert('–î–æ–∫—É–º–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω!');
          }else if(editingDocument){
            let fileUrl=editingDocument.file_url;
            let filename=editingDocument.filename;
            if(file){
              const newName = Date.now()+'_'+file.name;
              const up = await supabase.storage.from('documents').upload(newName, file);
              if(up.error) throw up.error;
              const { data:pub } = supabase.storage.from('documents').getPublicUrl(newName);
              fileUrl = pub.publicUrl; filename=file.name;
              if(editingDocument.file_url){
                const oldName = editingDocument.file_url.split('/').pop();
                if(oldName) await supabase.storage.from('documents').remove([oldName]);
              }
            }
            const { error } = await supabase.from('documents').update({
              filename, file_url:fileUrl, title, description, categories:[category], tags:selectedTags, actions, content:contentText
            }).eq('id', editingDocument.id);
            if(error) throw error;
            if(currentDocument && currentDocument.id===editingDocument.id){ Object.assign(currentDocument,{ filename, file_url:fileUrl, title, description, categories:[category], tags:selectedTags, actions, content:contentText }); }
            alert('–î–æ–∫—É–º–µ–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω!');
          }
          closeUploadModal();
          loadDocuments();
        }catch(e){ console.error('–û—à–∏–±–∫–∞:', e); alert('–û—à–∏–±–∫–∞: '+e.message); }
        finally{ btn.disabled=false; btn.textContent='–ó–∞–≥—Ä—É–∑–∏—Ç—å'; }
      });
 
     // ==== –ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ====
     function previewDocument(){
       if(!currentDocument) return;
       document.getElementById('previewTitle').textContent=currentDocument.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
       const c=document.getElementById('previewContent');
       const ext=(currentDocument.filename.split('.').pop()||'').toLowerCase();
       if(ext==='pdf'){ c.innerHTML=`<iframe src="${currentDocument.file_url}#toolbar=1&navpanes=0&scrollbar=1"></iframe>`; }
       else if(['jpg','jpeg','png'].includes(ext)){ c.innerHTML=`<img src="${currentDocument.file_url}" alt="${currentDocument.title||'–î–æ–∫—É–º–µ–Ω—Ç'}">`; }
       else { c.innerHTML='<div class="loading">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞</div>'; }
       document.getElementById('previewModal').classList.add('active'); document.body.style.overflow='hidden';
     }
     function closePreview(e){ if(!e || e.target.id==='previewModal'){ document.getElementById('previewModal').classList.remove('active'); document.body.style.overflow='auto'; } }
 
      function openDocumentModal(id){
        currentDocument = allDocuments.find(d=>d.id===id); if(!currentDocument) return;
        renderDocumentCard();
        document.getElementById('modalOverlay').classList.add('active'); document.body.style.overflow='hidden';
      }
      function closeModal(){ document.getElementById('modalOverlay').classList.remove('active'); document.body.style.overflow='auto'; currentDocument=null; }
      function closeModalOnOverlay(e){ if(e.target.id==='modalOverlay') closeModal(); }
 
      function renderDocumentCard(){
        if(!currentDocument) return;
        const doc=currentDocument;
        let catsHtml=(doc.categories||[]).map(c=>`<span class="category-pill"><span class="category-icon">${getCategoryIcon(c)}</span>${c}</span>`).join('');
         let tagsHtml=(doc.tags||[]).map(t=>`<span class="doc-tag" style="${getTagStyle(t)}border-color:transparent;">${t}</span>`).join('');
         let actionsHtml='';
         if(doc.actions?.length){
           const collapse = doc.actions.length>5;
           actionsHtml = `<ul class="doc-actions-list${collapse?' collapsed':''}" id="docActionsList">${doc.actions.map(a=>`<li>${a}</li>`).join('')}</ul>`+
                         (collapse?`<button class="show-more-actions" onclick="toggleActions()">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ (${doc.actions.length})</button>`:'');
         }
         let html = `
           <div class="doc-title">${doc.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
           ${doc.description?`<div class="doc-desc">${doc.description}</div>`:''}
           ${(doc.categories?.length)?`<div class="doc-section"><div class="section-label">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div><div class="doc-tags">${catsHtml}</div></div>`:''}
           ${(doc.tags?.length)?`<div class="doc-section"><div class="section-label">–¢–µ–≥–∏</div><div class="doc-tags">${tagsHtml}</div></div>`:''}
           ${(doc.actions?.length)?`<div class="doc-section"><div class="section-label">–î–µ–π—Å—Ç–≤–∏—è</div>${actionsHtml}</div>`:''}
           ${doc.content?`<div class="doc-section"><div class="section-label">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</div><div class="doc-content">${doc.content}</div></div>`:''}
           <div class="doc-actions-bar">
            <button class="icon-btn" onclick="previewDocument()" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">${ICONS.view}</button>
            <button class="icon-btn" onclick="editDocument()" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">${ICONS.edit}</button>
            <a class="icon-btn" href="${doc.file_url}" download="${doc.filename}" target="_blank" title="–°–∫–∞—á–∞—Ç—å">${ICONS.download}</a>
            <button class="icon-btn delete" onclick="deleteDocument('${doc.id}')" title="–£–¥–∞–ª–∏—Ç—å">${ICONS.trash}</button>
           </div>`;
         document.getElementById('modalContent').innerHTML=html;
       }
      function editDocument(){ const doc=currentDocument; closeModal(); openUploadModal(doc); }
      function toggleActions(){
       const list=document.getElementById('docActionsList'); const btn=event.target;
       if(list.classList.contains('collapsed')){ list.classList.remove('collapsed'); btn.textContent='–°–≤–µ—Ä–Ω—É—Ç—å'; }
       else { list.classList.add('collapsed'); btn.textContent='–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ ('+(currentDocument.actions?.length||0)+')'; }
     }
     async function deleteDocument(id){
       if(!confirm('–£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç?')) return;
       const doc = allDocuments.find(d=>d.id===id); if(!doc) return;
       const fileName = doc.file_url.split('/').pop();
       await supabase.storage.from('documents').remove([fileName]);
       const { error } = await supabase.from('documents').delete().eq('id', id);
       if(error){ alert('–û—à–∏–±–∫–∞: '+error.message); return; }
       alert('–î–æ–∫—É–º–µ–Ω—Ç —É–¥–∞–ª–µ–Ω'); closeModal(); loadDocuments();
     }
 
     // ==== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∞–∫—Å–æ–Ω–æ–º–∏–∏ ====
     function openSettings(type){ renderSettings(type); document.getElementById('settingsOverlay').classList.add('active'); document.body.style.overflow='hidden'; }
     function closeSettings(){ document.getElementById('settingsOverlay').classList.remove('active'); document.body.style.overflow='auto'; }
     function closeSettingsOnOverlay(e){ if(e.target.id==='settingsOverlay') closeSettings(); }
 
     function renderSettings(type){
       const title = (type==='tags')?'–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞–º–∏':'–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏';
       document.getElementById('settingsTitle').textContent = title;
       const list = (type==='tags')?PREDEFINED_TAGS:PREDEFINED_CATEGORIES;
       let html = '<div class="settings-list">';
       list.forEach(val=>{
        const icon = type==='categories'?`<span class="chip-icon">${getCategoryIcon(val)}</span>`:'';
        const iconBtn = type==='categories'?`<button class="chip-action" title="–ò–∫–æ–Ω–∫–∞" onclick="promptCategoryIcon('${encodeURIComponent(val)}')">${ICONS.gear}</button>`:'';
        html += `<span class="chip">${icon}${val}${iconBtn}<button title="–£–¥–∞–ª–∏—Ç—å" onclick="removeItem('${type}','${encodeURIComponent(val)}')">√ó</button></span>`;
       });
       html += '</div>';
       html += `
         <div class="settings-row">
           <input id="settingsInput" type="text" placeholder="–î–æ–±–∞–≤–∏—Ç—å ${type==='tags'?'—Ç–µ–≥':'–∫–∞—Ç–µ–≥–æ—Ä–∏—é'}">
           <button class="btn btn-primary" style="flex:0 0 auto;min-width:120px" onclick="addItem('${type}')">–î–æ–±–∞–≤–∏—Ç—å</button>
         </div>
         <div class="help-text" style="margin-top:8px">–•—Ä–∞–Ω–∏—Ç—Å—è –≤ Supabase. <a href="#" onclick="resetDefaults();return false;" style="color:#72E4A0;text-decoration:underline;">–°–±—Ä–æ—Å –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</a></div>
       `;
       document.getElementById('settingsContent').innerHTML=html;
     }
 
    async function addItem(type, customVal){
       const input=document.getElementById('settingsInput');
      const raw = customVal!==undefined ? customVal : (input?.value||'');
      const val=(raw||'').trim();
       if(!val) return;
       if(type==='tags' || type==='categories'){
        if(type==='tags') ensureTagColor(val);
         const { error } = await supabase.rpc('taxonomy_add', { kind:type, value:val });
         if(error){ alert('–û—à–∏–±–∫–∞: '+error.message); return; }
       }
       await loadTaxonomy();
      populateCategorySelect(); populateCategoryFilter(); populateTagSelector(); updateTagSuggestions(); renderSettings(type);
      if(type==='categories') document.getElementById('categorySelect').value=val;
      if(!customVal && input) input.value='';
     }
 
     async function removeItem(type, encodedVal){
      const valRaw = decodeURIComponent(encodedVal||'');
      const val=valRaw.trim();
       if(!val) return;
       if(type==='tags' || type==='categories'){
         const { error } = await supabase.rpc('taxonomy_remove', { kind:type, value:val });
         if(error){ alert('–û—à–∏–±–∫–∞: '+error.message); return; }
       }
      if(type==='categories' && CATEGORY_ICONS[val]){ delete CATEGORY_ICONS[val]; persistCategoryIcons(); }
       await loadTaxonomy();
      populateCategorySelect(); populateCategoryFilter(); populateTagSelector(); updateTagSuggestions(); renderSettings(type);
     }
 
     async function resetDefaults(){
       const { error } = await supabase.from('taxonomy').update({ categories: DEFAULT_CATEGORIES, tags: DEFAULT_TAGS }).eq('slug','global');
       if(error){ alert('–û—à–∏–±–∫–∞: '+error.message); return; }
       await loadTaxonomy();
      populateCategorySelect(); populateCategoryFilter(); populateTagSelector(); updateTagSuggestions();
       const t=document.getElementById('settingsTitle').textContent; renderSettings(t.includes('—Ç–µ–≥')?'tags':'categories');
     }
 
    function promptCategoryIcon(encodedCat){
      const cat=decodeURIComponent(encodedCat||'');
      if(!cat) return;
      const current=getCategoryIcon(cat);
      const icon=prompt('–í–≤–µ–¥–∏—Ç–µ —ç–º–æ–¥–∑–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è üíæ', current);
      if(icon===null) return;
      CATEGORY_ICONS[cat]=(icon.trim()||'üíæ');
      persistCategoryIcons();
      renderCategoryChips();
      renderDocuments(allDocuments);
      if(currentDocument) renderDocumentCard();
    }
    function openCategoryIconPrompt(){
      const cat=document.getElementById('categorySelect').value;
      if(!cat){ alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é'); return; }
      promptCategoryIcon(encodeURIComponent(cat));
    }

     // ==== –†–µ–∞–ª—Ç–∞–π–º ====
     function initRealtime(){
        supabase.channel('taxonomy_changes')
          .on('postgres_changes', { event:'*', schema:'public', table:'taxonomy' }, async ()=>{ await loadTaxonomy(); populateCategorySelect(); populateCategoryFilter(); populateTagSelector(); updateTagSuggestions(); applyFilters(); })
          .subscribe();
       supabase.channel('documents_changes')
         .on('postgres_changes', { event:'*', schema:'public', table:'documents' }, async ()=>{ await loadDocuments(); applyFilters(); })
         .subscribe();
     }
 
     // Esc –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫–∏
     document.addEventListener('keydown', e=>{
       if(e.key==='Escape'){
         const previewModal=document.getElementById('previewModal');
         const mainModal=document.getElementById('modalOverlay');
         const uploadModal=document.getElementById('uploadModal');
         const settingsModal=document.getElementById('settingsOverlay');
         if(previewModal.classList.contains('active')) closePreview();
        else if(mainModal.classList.contains('active')) { closeModal(); }
         else if(uploadModal.classList.contains('active')) closeUploadModal();
         else if(settingsModal.classList.contains('active')) closeSettings();
       }
     });
 
     // –°—Ç–∞—Ä—Ç
     initializeApp();
   </script>
 </body>
 </html>
